<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Águas</title>

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --bg-color: #f4f7f6;
            --font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --border-radius: 6px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Estilo Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--dark-color);
            padding-top: 80px; /* Espaço para o cabeçalho fixo */
        }

        #app {
            width: 100%;
            max-width: 1200px;
            padding: 1rem;
            margin: 0 auto; /* Centra o container principal */
            display: flex; /* Use flexbox for main content + sidebar */
            flex-direction: column; /* Default to column for small screens */
        }

        /* Classes de Utilidade */
        .hidden {
            display: none !important;
        }
        .text-danger {
            color: var(--danger-color);
        }
        .text-success {
            color: var(--success-color);
        }

        /* Cabeçalho */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--box-shadow);
            z-index: 1000;
        }
        header h1 {
            font-size: 1.5rem;
            padding-left: 1rem;
        }
        header button {
            margin-right: 1rem;
        }

        /* Botões */
        button, .button {
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        button:hover, .button:hover {
            opacity: 0.9;
        }
        button:active, .button:active {
            transform: scale(0.98);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-warning {
             background-color: var(--warning-color);
             color: var(--dark-color);
        }
        .btn-icon {
            padding: 0.5rem;
            line-height: 1;
        }

        /* Painel de Menu */
        aside {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px; /* Adjusted for smaller screens */
            height: 100%;
            background-color: white;
            box-shadow: var(--box-shadow);
            padding: 60px 1.5rem 1.5rem;
            transform: translateX(-250px); /* Adjusted width */
            transition: transform 0.3s ease-in-out;
            z-index: 1001;
        }
        aside.open {
            transform: translateX(0);
        }
        #admin-actions button {
            display: block;
            width: 100%;
            text-align: left;
            margin-bottom: 1rem;
            background-color: var(--light-color);
        }

        /* Conteúdo Principal e Vistas */
        main section {
            background-color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-top: 1.5rem;
        }
        main h2 {
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 0.5rem;
        }

        /* Tabelas */
        .table-responsive {
            overflow-x: auto; /* Make tables horizontally scrollable on small screens */
            -webkit-overflow-scrolling: touch; /* Smoother scrolling on iOS */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            min-width: 600px; /* Ensure table has a minimum width to enable scrolling */
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        thead th {
            background-color: var(--light-color);
            font-weight: bold;
        }
        /* Efeito Zebra */
        tbody tr:nth-child(even) {
            background-color: #f2f2f2; /* Cor mais escura para linhas pares */
        }
        tbody tr:hover {
            background-color: #e0e0e0; /* Hover effect */
        }

        td[contenteditable="true"] {
            background-color: #fffbe6;
            outline: 1px dashed var(--warning-color);
            cursor: cell;
        }
        .payment-date {
            font-size: 0.75rem;
            color: var(--secondary-color);
            display: block;
            margin-top: 4px;
        }
        .payment-cell-value {
             cursor: pointer;
             display: inline-block;
             padding: 4px;
             border-radius: 4px;
             border: 1px dashed transparent;
             transition: all 0.2s ease-in-out;
        }
        .payment-cell-value:hover {
             background-color: #fffbe6;
             border-color: var(--warning-color);
        }
        .situacao-select {
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            background-color: white;
        }


        /* Ações na Tabela */
        .actions-cell > button {
            margin-right: 5px;
        }
        .actions-cell .action-toggle {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.5rem 1rem;
        }
        .actions-cell .action-buttons {
            display: none;
            margin-top: 5px;
        }
        .actions-cell .action-buttons.visible {
            display: block;
        }
        .actions-cell .action-buttons button {
            display: inline-block;
            width: auto;
            margin-right: 5px;
            padding: 0.5rem;
            font-size: 0.8rem;
            margin-bottom: 5px; /* Added for better stacking on small screens */
        }

        /* Formulários e Inputs */
        form .form-group {
            margin-bottom: 1.5rem;
        }
        form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        input[type="text"], input[type="password"], input[type="date"], input[type="number"], select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        .input-group {
            display: flex;
        }
        .input-group-text {
            padding: 0.75rem;
            background-color: var(--light-color);
            border: 1px solid #ccc;
            border-right: none;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }
        .input-group input {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }
        .read-only-input {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        /* Janela Modal */
        #client-modal, #contract-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem; /* Added padding for small screens */
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 90vh; /* Prevent modal from overflowing on very small screens */
            overflow-y: auto; /* Enable scrolling for modal content if needed */
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--secondary-color);
        }
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 1.5rem;
        }

        /* Estilos para Recibos */
        .receipt {
            border: 2px solid var(--dark-color);
            padding: 1rem;
            margin-bottom: 2rem;
            font-family: 'Courier New', Courier, monospace;
            background-color: #fff;
            border-radius: var(--border-radius); /* Arredondado */
            box-shadow: var(--box-shadow); /* Sombra */
        }
        .receipt-header {
            text-align: center;
            border-bottom: 1px solid var(--dark-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .receipt-header h4 {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .receipt-body p {
            line-height: 1.8;
        }
        .receipt-body .data-field {
            font-weight: bold;
            display: inline-block;
            padding: 0 0.5rem;
            text-decoration: underline;
            text-underline-offset: 2px;
            min-width: 90px;
        }
        .receipt-body table {
            width: 100%;
            font-size: 0.9rem;
            border-collapse: collapse;
            border: 1px solid var(--dark-color);
        }
        .receipt-body table th,
        .receipt-body table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        thead th {
            background-color: var(--light-color);
            font-weight: bold;
        }
        .receipt-body table tbody tr:hover {
            background-color: #f5f5f5;
        }
        .receipt-body table td[colspan] {
            text-align: right;
            font-weight: bold;
        }
        .receipt-body table .data-field {
             text-decoration: none;
        }
        .receipt-footer {
            margin-top: 1rem;
            padding-top: 0.5rem;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .receipt-footer p {
            margin-bottom: 0; /* CORREÇÃO PARA ECRÃ */
        }

        /* Estilo para a linha que divide as faturas no ecrã */
        .invoice-divider {
            margin: 2rem 0;
            border: none;
            border-top: 2px dashed var(--secondary-color);
        }


        /* --- INÍCIO: ESTILOS DE IMPRESSÃO --- */
        @media print {
            /* 1. Oculta todos os elementos que estão diretamente no <body> */
            body > * {
                display: none !important;
            }

            /* 2. Mostra o contentor da aplicação e o caminho até à secção de recibos */
            #app, main, #receipts-view {
                display: block !important;
            }
            
            /* 3. Remove paddings, margens e sombras para aproveitar a página toda */
            body, #app, main, #receipts-view {
                padding: 0 !important;
                margin: 0 !important;
                background-color: white !important;
                box-shadow: none !important;
                border: none !important;
                color: #000 !important; /* Garante texto preto na impressão */
            }

            /* 4. Oculta o cabeçalho da vista de recibos (que tem o título e o botão) */
            #receipts-view > div:first-of-type {
                display: none !important;
            }

            /* 5. Garante que o container dos recibos está visível e centralizado para impressão */
            #receipts-container {
                display: block !important;
                width: 21cm; /* A4 width */
                margin: 0 auto !important; /* Centraliza na página A4 */
            }

            /* 6. A linha divisória para a seção de recibos deverá estar visível na impressão */
            .invoice-divider {
                display: block !important; /* Changed from none to block */
                margin: 2rem 0 !important; /* Ensure it has space */
                border-top: 2px dashed var(--secondary-color) !important; /* Make sure it's dashed and visible */
            }

            /* 7. Estilo principal para cada recibo na impressão (usado na nova janela de impressão) */
            .recibo-popup {
                width: 21cm !important; /* Largura total da folha A4 */
                height: 12.8cm !important; /* Altura ajustada para caber dois por página */
                margin: 0.8cm 0 0.4cm !important; /* Margem superior, sem margens laterais, e inferior reduzida */
                border: 1px solid black !important;
                padding: 20px !important; /* Padding do recibo */
                box-sizing: border-box !important;
                font-family: monospace !important;
                position: relative !important;
                page-break-after: auto !important; /* CRÍTICO: Não forçar quebras de página após CADA recibo na nova janela */
                page-break-inside: avoid; /* Prevent breaking a receipt in half */
            }

            /* Se houver mais de 2 recibos, o ideal é que cada par se ajuste */
            /* Para 2 recibos por página, esta regra é fundamental */
            .recibo-popup:nth-child(even) { /* Para o segundo recibo em cada par */
                /* margin-top: 0.8cm !important; */ /* This can be removed, as the general margin and divider will handle spacing */
            }
            
            /* Ajustar os tamanhos de fonte para o recibo ficar mais compacto na impressão */
            .recibo-popup .cabecalho .agua-paz {
                font-size: 16pt;
            }
            .recibo-popup .cabecalho .recibo-num {
                font-size: 12pt;
            }
            .recibo-popup .linha {
                font-size: 10pt;
                line-height: 1.2;
            }
            .recibo-popup .checklist label {
                font-size: 9pt;
            }
            .recibo-popup .assinatura-maquina {
                font-size: 11pt;
            }
            .carimbo-overlay {
                top: -35px !important; /* Ajuste a posição vertical do carimbo para impressão */
                left: 50%; /* Centraliza horizontalmente */
                transform: translateX(-50%); /* Ajuste fino para centralizar */
                width: 150px !important; /* Pode ser necessário ajustar o tamanho do carimbo */
            }

            /* Estilo da nova linha HR para impressão */
            .receipt-divider-print {
                border: none;
                border-top: 1px dashed #999; /* Linha tracejada suave */
                margin: 0.4cm auto !important; /* Margem para separar os recibos */
                width: 80% !important; /* Largura da linha divisória */
                display: block !important; /* Garante que a linha é visível na impressão */
            }

            /* Outros ajustes finos para tabelas dentro do recibo, se aplicável */
            .receipt-body table {
                font-size: 8pt !important;
                margin-top: 0.3cm !important; /* Reduzir a margem superior da tabela */
            }
            .receipt-body table th,
            .receipt-body table td {
                padding: 0.15cm !important; /* Reduzir padding das células da tabela */
                border: 1px solid #333 !important;
            }
            .receipt-footer {
                font-size: 8pt !important;
                margin-top: 0.3cm !important;
                padding-top: 0.15cm !important;
            }
            .receipt-footer p {
                margin-bottom: 0 !important;
            }
            /* Explicitly set for print to ensure row layout */
            .recibo-popup .assinatura-checklist-container {
                flex-direction: row !important; /* Force side-by-side for print */
                justify-content: space-between !important;
                align-items: flex-start !important;
            }
            .recibo-popup .checklist,
            .recibo-popup .assinatura {
                width: 48% !important; /* Ensure they share space */
                margin-bottom: 0 !important;
            }
            .recibo-popup .assinatura {
                text-align: right !important; /* Align signature text to the right for print */
            }

            /* Novo estilo para o topo da seção de pagamento/assinatura no recibo de impressão */
            .recibo-popup .receipt-top-info {
                display: flex !important;
                justify-content: space-between !important;
                align-items: flex-end !important; /* Alinhar texto com a parte de baixo */
                font-weight: bold !important;
                font-size: 10pt !important; /* Ajuste o tamanho da fonte para impressão */
                margin-bottom: 5px !important; /* Espaço entre o cabeçalho e os checkboxes */
            }

            .recibo-popup .receipt-top-info .assinatura-header-print {
                margin-top: 0 !important; /* Remover margem extra no topo */
                margin-bottom: 0 !important; /* Remover margem extra no rodapé */
            }
        }
        /* --- FIM: ESTILOS DE IMPRESSÃO --- */

        /* Estilos do Recibo Separado (apenas para visualização em ecrã, será sobrescrito pelo @media print) */
        .recibo-popup {
            width: 97%;
            height: 45%; /* Esta altura será sobrescrita pela media query de impressão */
            border: 1px solid black;
            padding: 20px;
            box-sizing: border-box;
            font-family: monospace;
            position: relative;
        }

        .recibo-popup .cabecalho {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .recibo-popup .agua-paz {
            font-size: 20px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .recibo-popup .recibo-num {
            font-size: 16px;
            text-align: right; /* Align to the right */
        }

        .recibo-popup .linha {
            margin: 10px 0;
        }

        .recibo-popup .assinatura {
            margin-top: 10px;
            text-align: right;
            position: relative; /* Adicionado para posicionamento do carimbo */
        }
        /* Estilo para o texto "Assinatura e carimbo" */
        .recibo-popup .assinatura span {
            font-weight: bold; /* Deixar o texto em negrito */
            font-size: 1rem; /* Pode ajustar o tamanho da fonte */
        }


        .recibo-popup .assinatura-maquina {
            margin-top: 30px;
            font-size: 14px;
        }

        .recibo-popup .checklist {
            margin-top: 10px;
            text-align: left;
        }
        /* Estilo para o texto "Forma de pagamento" */
        .recibo-popup .checklist span.payment-form-header {
            font-weight: bold; /* Deixar o texto em negrito */
            font-size: 1rem; /* Pode ajustar o tamanho da fonte */
        }


        .recibo-popup .assinatura-checklist-container {
            display: flex;
            flex-direction: row; /* Change to row for side-by-side */
            justify-content: space-between; /* Pushes items to the ends */
            align-items: flex-start; /* Aligns them to the top of the container */
            margin-top: 30px;
        }

        .recibo-popup .checklist,
        .recibo-popup .assinatura {
            width: 48%; /* Give them approximately half width to sit side-by-side */
            margin-bottom: 0; /* Remove bottom margin when side-by-side */
        }
        .recibo-popup .assinatura {
            text-align: right; /* Align signature text to the right */
        }

        /* Novo estilo para o topo da seção de pagamento/assinatura no recibo */
        .recibo-popup .receipt-top-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-end; /* Alinhar o texto com a parte de baixo */
            margin-bottom: 10px; /* Espaço entre o cabeçalho e os checkboxes */
            font-weight: bold; /* Deixar o texto em negrito */
        }
        .recibo-popup .receipt-top-info .assinatura-header {
            margin-top: 0;
            margin-bottom: 0;
        }


        .fill-underline {
            font-family: monospace;
            white-space: pre; /* Preserve whitespace for underscores */
            text-decoration: none; /* Remove default underline if any */
            display: inline-flex; /* Use inline-flex for content centering */
            align-items: center; /* Center content vertically */
            justify-content: center; /* Center content horizontally */
            min-width: 50px; /* Minimum width for the filled area */
            border-bottom: 1px solid black; /* Simulate underline with border */
            box-sizing: border-box; /* Include padding/border in width */
            padding: 0 2px; /* Small padding to prevent text from touching border */
        }

        /* New style to hide underscores if data fills the space */
        .fill-underline.no-underline {
            border-bottom: none;
            text-decoration: none;
        }

        /* Custom styles for receipt data */
        .data-field-blue {
            color: blue;
        }
        .data-field-red {
            color: red;
        }
        .no-underline-month {
            text-decoration: none !important;
            border-bottom: none !important;
        }

        /* Estilo para a imagem do carimbo */
        .carimbo-overlay {
            position: absolute;
            top: -42.8px; /* Original -5px - 37.8px = -42.8px (1cm para cima) */
            left: 50%; /* Centraliza horizontalmente */
            transform: translateX(-50%); /* Ajuste fino para centralizar */
            width: 170px; /* Aumentado de 160px para 170px */
            height: auto;
            opacity: 0.8; /* Opacidade para simular carimbo */
            z-index: 10; /* Garante que fique acima da linha */
            margin-left: 64.26px; /* Original 113.4px - 49.14px = 64.26px (1.3cm para a esquerda) */
        }


        /* --- RESPONSIVIDADE --- */

        /* Pequenas telas (smartphones) */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.2rem;
                padding-left: 0.5rem;
            }
            header button {
                margin-right: 0.5rem;
            }
            
            #app {
                padding: 0.5rem;
            }

            main section {
                padding: 1rem;
                margin-top: 1rem;
            }

            /* Search input on top of tables */
            #clients-view div, #payments-view div, #invoices-view div {
                flex-direction: column;
                align-items: flex-start;
            }
            #client-search-clients, #client-search-payments, #invoice-search {
                width: 100% !important; /* Override inline style */
                margin-top: 10px;
            }

            /* Adjust button padding and font for smaller screens */
            button, .button {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            .actions-cell .action-buttons button {
                padding: 0.4rem;
                font-size: 0.75rem;
            }

            /* Receipts container */
            #receipts-container {
                padding: 0.5rem;
            }

            .recibo-popup .cabecalho {
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 10px;
            }
            .recibo-popup .recibo-num {
                text-align: left;
                margin-top: 10px;
            }
            .recibo-popup .assinatura-checklist-container {
                flex-direction: column;
                align-items: flex-start;
            }
            .recibo-popup .checklist,
            .recibo-popup .assinatura {
                width: 100%;
                margin-bottom: 15px;
            }
            .recibo-popup .assinatura {
                text-align: left; /* Align signature left when stacked */
            }
            .carimbo-overlay {
                top: auto !important; /* Reset top for mobile view */
                bottom: -20px; /* Position relative to signature area */
                left: 10px !important; /* Align left with text */
                transform: translateX(0) !important;
                width: 100px !important; /* Smaller stamp on mobile */
                margin-left: 0 !important;
            }
            /* Adjust for stacked layout on small screens */
            .recibo-popup .receipt-top-info {
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 5px;
            }
            .recibo-popup .receipt-top-info .assinatura-header {
                margin-top: 10px; /* Add space when stacked */
            }
        }

        /* Médias telas (tablets) */
        @media (min-width: 769px) and (max-width: 1024px) {
            aside {
                width: 280px;
                transform: translateX(-280px);
            }
            aside.open {
                transform: translateX(0);
            }
            #app {
                padding: 1rem;
            }
            main section {
                padding: 1.2rem;
            }
        }

        /* Telas grandes (desktops) */
        @media (min-width: 1025px) {
            #app {
                display: block; /* Revert to block for desktop */
            }
            aside {
                position: fixed; /* Keep fixed for overlay behavior */
                width: 300px; /* Original width */
                transform: translateX(-300px); /* Original transform */
            }
            aside.open {
                transform: translateX(0);
            }
            /* Restore original flex for signature/checklist for larger screens */
            .recibo-popup .assinatura-checklist-container {
                flex-direction: row;
            }
            .recibo-popup .checklist,
            .recibo-popup .assinatura {
                width: 48%;
                margin-bottom: 0;
            }
            .recibo-popup .assinatura {
                text-align: right;
            }
            .carimbo-overlay {
                top: -42.8px !important; /* Revert to original position */
                left: 50% !important; /* Revert to original position */
                transform: translateX(-50%) !important;
                width: 170px !important; /* Revert to original size */
                margin-left: 64.26px !important; /* Revert to original position */
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>💧 Gestão de Águas</h1>
        <button id="menu-button" class="btn-primary">Menu</button>
    </header>

    <aside id="side-menu">
        <section id="auth-section">
            <h3>Acesso Restrito</h3>
            <form id="auth-form">
                <div class="form-group">
                    <label for="verification-code">Código de Verificação</label>
                    <input type="password" id="verification-code" required>
                </div>
                <button type="submit" class="btn-primary">Entrar</button>
            </form>
        </section>

        <section id="admin-actions" class="hidden">
            <button data-action="add-client">Adicionar Cliente</button>
            <button data-view="clients-view">Ver Clientes</button>
            <button data-view="invoices-view">Ver Faturas</button>
            <button data-view="payments-view">Ver Pagamentos</button>
            <button data-action="add-contract">Adicionar Contrato</button>
            <button data-view="contracts-view">Ver Contratos</button>
            <button data-view="receipts-view">Gerar Recibos</button>
        </section>
    </aside>

    <div id="app">
        <main>
            <section id="clients-view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Clientes</h2>
                    <input type="text" id="client-search-clients" placeholder="Pesquisar por nome ou ID..." style="width: 50%;">
                </div>
                <div class="table-responsive">
                    <table id="clients-table">
                        <thead>
                            <tr>
                                <th>Nº Cliente</th>
                                <th>Nome</th>
                                <th>Contacto</th>
                                <th>Data da Ligação</th>
                                <th>Situação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table-body"></tbody>
                    </table>
                </div>
            </section>

            <section id="invoices-view" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Gestão de Faturas</h2>
                    <input type="text" id="invoice-search" placeholder="Pesquisar por nome ou ID..." style="width: 50%;">
                    <button id="new-month-button" class="btn-warning">🚀 Novo Mês</button>
                </div>
                <div class="table-responsive">
                    <table id="invoices-table">
                        <thead>
                            <tr>
                                <th>Nº</th>
                                <th>Nome Cliente</th>
                                <th>Leitura Anterior (m³)</th>
                                <th>Leitura Atual (m³)</th>
                                <th>Consumo (m³)-</th>
                                <th>Dívida (MZN)</th>
                                <th>Valor a Pagar (MZN)</th>
                            </tr>
                        </thead>
                        <tbody id="invoices-table-body"></tbody>
                    </table>
                </div>
            </section>

            <section id="payments-view" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Gestão de Pagamentos</h2>
                    <input type="text" id="client-search-payments" placeholder="Pesquisar por nome ou ID..." style="width: 50%;">
                </div>
                <div class="table-responsive">
                    <table id="payments-table">
                        <thead>
                            <tr>
                                <th>Nome Cliente</th>
                                <th>Valor Total (MZN)</th>
                                <th>1º Pagamento (MZN)</th>
                                <th>2º Pagamento (MZN)</th>
                                <th>3º Pagamento (MZN)</th>
                                <th>Valor em Falta (MZN)</th>
                                <th>Comprovativo</th>
                            </tr>
                        </thead>
                        <tbody id="payments-table-body"></tbody>
                    </table>
                </div>
            </section>

            <section id="contracts-view" class="hidden">
                <h2>Dívidas Contratuais</h2>
                <div class="table-responsive">
                    <table id="contracts-table">
                        <thead>
                            <tr>
                                <th>Nº Contrato</th>
                                <th>Nº Cliente</th>
                                <th>Nome Cliente</th>
                                <th>Valor Contrato (MZN)</th>
                                <th>1º Pagamento (MZN)</th>
                                <th>2º Pagamento (MZN)</th>
                                <th>3º Pagamento (MZN)</th>
                                <th>Valor em Falta (MZN)</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="contracts-table-body"></tbody>
                    </table>
                </div>
            </section>

            <section id="receipts-view" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Recibos Gerados</h2>
                    <button id="print-receipts-button" class="btn-primary">Imprimir (Não Usar)</button>
                </div>
                <div id="receipts-container">
                    </div>
            </section>
        </main>
    </div>

    <div id="client-modal" class="hidden">
        <div class="modal-content">
            <button class="modal-close" id="close-client-modal-button">&times;</button>
            <h3 id="client-modal-title">Adicionar Cliente</h3>
            <form id="client-form">
                <input type="hidden" id="client-id">
                <div class="form-group">
                    <label for="client-name">Nome</label>
                    <input type="text" id="client-name" required>
                </div>
                <div class="form-group">
                    <label for="client-contact">Contacto</label>
                    <div class="input-group">
                        <span class="input-group-text">+258</span>
                        <input type="text" id="client-contact" required pattern="\d{9}" title="Insira um número de 9 dígitos.">
                    </div>
                </div>
                <div class="form-group">
                    <label for="client-connection-date">Data da Ligação</label>
                    <input type="date" id="client-connection-date" required>
                </div>
                <button type="submit" class="btn-success">Salvar</button>
            </form>
        </div>
    </div>

    <div id="contract-modal" class="hidden">
        <div class="modal-content">
            <button class="modal-close" id="close-contract-modal-button">&times;</button>
            <h3 id="contract-modal-title">Adicionar Contrato</h3>
            <form id="contract-form">
                <input type="hidden" id="contract-id">
                <div class="form-group">
                    <label for="contract-client-select">Cliente</label>
                    <select id="contract-client-select" style="width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: var(--border-radius);" required></select>
                </div>
                <div class="form-group">
                    <label for="contract-value">Valor do Contrato (MZN)</label>
                    <input type="number" id="contract-value" value="5000" min="0" step="1" required>
                </div>
                <button type="submit" class="btn-success">Salvar Contrato</button>
            </form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Seletores de elementos do DOM
    const menuButton = document.getElementById('menu-button');
    const sideMenu = document.getElementById('side-menu');
    const authSection = document.getElementById('auth-section');
    const adminActions = document.getElementById('admin-actions');
    const authForm = document.getElementById('auth-form');
    const verificationCodeInput = document.getElementById('verification-code');
    const views = document.querySelectorAll('main > section');

    const clientModal = document.getElementById('client-modal');
    const closeClientModalButton = document.getElementById('close-client-modal-button');
    const clientForm = document.getElementById('client-form');
    const clientModalTitle = document.getElementById('client-modal-title');
    const clientIdInput = document.getElementById('client-id');
    const clientNameInput = document.getElementById('client-name');
    const clientContactInput = document.getElementById('client-contact');
    const clientConnectionDateInput = document.getElementById('client-connection-date');
    const clientsTableBody = document.getElementById('clients-table-body');
    const clientSearchClients = document.getElementById('client-search-clients');

    const invoicesTableBody = document.getElementById('invoices-table-body');
    const invoiceSearch = document.getElementById('invoice-search'); // Added for invoice search
    const paymentsTableBody = document.getElementById('payments-table-body');
    const clientSearchPayments = document.getElementById('client-search-payments');

    const contractsTableBody = document.getElementById('contracts-table-body');
    const contractModal = document.getElementById('contract-modal');
    const closeContractModalButton = document.getElementById('close-contract-modal-button');
    const contractForm = document.getElementById('contract-form');
    const contractModalTitle = document.getElementById('contract-modal-title');
    const contractIdInput = document.getElementById('contract-id'); // Not used for contract ID, but for selected client ID
    const contractClientSelect = document.getElementById('contract-client-select');
    const contractValueInput = document.getElementById('contract-value');

    const receiptsContainer = document.getElementById('receipts-container');
    const newMonthButton = document.getElementById('new-month-button');
    const printReceiptsButton = document.getElementById('print-receipts-button');

    // Estado da aplicação
    let state = { clients: [], invoices: {}, payments: {}, contracts: {} };
    const FIXED_VERIFICATION_CODE = '123456a';
    let originalCellValue = null;
    const generatedBinarySignatures = new Set(); // To store unique binary signatures

    // --- LÓGICA DE SEGURANÇA ---
    function requestVerificationCode(onSuccess, onFail = () => {}) {
        const code = prompt("Para realizar esta ação, por favor, insira o código de verificação:");
        if (code === FIXED_VERIFICATION_CODE) {
            onSuccess();
        } else if (code !== null) {
            alert('Código de verificação incorreto!');
            onFail();
        } else {
             onFail(); // User cancelled prompt
        }
    }

    // --- PERSISTÊNCIA ---
    function saveData() {
        localStorage.setItem('waterManagementData', JSON.stringify(state));
    }

    function loadData() {
        const data = localStorage.getItem('waterManagementData');
        if (data) {
            state = JSON.parse(data);
            // Ensure default situacao for old data and correct structure for payments/contracts
            state.clients.forEach(client => {
                if (client.situacao === undefined) {
                    client.situacao = 'A';
                }
            });
            // Ensure payment objects have amount and date for p1, p2, p3
            for (const clientId in state.payments) {
                ['p1', 'p2', 'p3'].forEach(p => {
                    if (state.payments[clientId][p] === undefined) {
                        state.payments[clientId][p] = { amount: 0, date: null };
                    } else if (typeof state.payments[clientId][p] === 'number') { // Convert old number format
                         state.payments[clientId][p] = { amount: state.payments[clientId][p], date: null };
                    }
                });
            }
             // Ensure contract payment objects have amount and date
            for (const contractId in state.contracts) {
                ['p1', 'p2', 'p3'].forEach(p => {
                    if (state.contracts[contractId].payments[p] === undefined) {
                        state.contracts[contractId].payments[p] = { amount: 0, date: null };
                    }
                });
            }

        } else {
            state = {
                clients: [
                    { id: 1, name: 'António Luís', contact: '841234567', connectionDate: '2023-01-15', situacao: 'A' },
                    { id: 2, name: 'Elias Manue', contact: '867654321', connectionDate: '2023-02-20', situacao: 'A' },
                    { id: 3, name: 'Alberto', contact: '829876543', connectionDate: '2023-03-10', situacao: 'F' }
                ],
                invoices: {
                    1: { prevReading: 5, currentReading: 15, debt: 0, customAmount: null },
                    2: { prevReading: 6, currentReading: 26, debt: 150, customAmount: null },
                    3: { prevReading: 7, currentReading: 7, debt: 525, customAmount: null }
                },
                payments: {
                    1: { p1: { amount: 375, date: '2025-05-26T10:00:00.000Z' }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } },
                    2: { p1: { amount: 600, date: '2025-05-26T11:00:00.000Z' }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } },
                    3: { p1: { amount: 0, date: null }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } }
                },
                contracts: {} // New empty contracts object
            };
        }
    }

    // --- FUNÇÃO AUXILIAR DE CÁLCULO ---
    function calculateInvoiceTotals(clientId) {
        const invoice = state.invoices[clientId] || { prevReading: 0, currentReading: 0, debt: 0, customAmount: null };
        const client = state.clients.find(c => c.id == clientId);

        let consumption = 0;
        let tariff = 0;
        let totalToPay = 0; // Initialize totalToPay

        if (client && client.situacao === 'F') { // Cliente Fechado: não calcula consumo, apenas dívida
            consumption = 0;
            tariff = 0; // Não há tarifa de consumo para cliente fechado
            totalToPay = parseFloat(invoice.debt) || 0; // Only debt
        } else if (client && client.situacao === 'N') { // Cliente com Situação 'N': não calcula consumo, apenas dívida
            consumption = 0;
            tariff = 0;
            totalToPay = parseFloat(invoice.debt) || 0; // Only debt
        }
        else if (client && client.situacao === 'A' && (invoice.currentReading || 0) === (invoice.prevReading || 0)) {
            // Situation A and Consumption is 0
            consumption = 0;
            tariff = 0;
            totalToPay = (parseFloat(invoice.debt) || 0) + 375; // Debt + 375
        }
        else {
            const hasNewReading = (invoice.currentReading || 0) > 0 && (invoice.currentReading || 0) > (invoice.prevReading || 0);
            consumption = Math.max(0, (invoice.currentReading || 0) - (invoice.prevReading || 0));
            tariff = hasNewReading ? (consumption <= 5 ? 375 : consumption * 75) : 0;
            totalToPay = (parseFloat(invoice.debt) || 0) + tariff; // Debt + tariff
        }

        if (invoice.customAmount != null) {
            totalToPay = parseFloat(invoice.customAmount); // Use custom amount if available
        }

        return { consumption, tariff, totalToPay };
    }

    function calculateContractTotals(contractId) {
        const contract = state.contracts[contractId];
        if (!contract) return { totalPaid: 0, remaining: 0 };

        const totalPaid = (contract.payments.p1.amount || 0) +
                          (contract.payments.p2.amount || 0) +
                          (contract.payments.p3.amount || 0);
        const remaining = contract.value - totalPaid;
        return { totalPaid, remaining };
    }


    // --- RENDERIZAÇÃO ---
    function renderAllTables() {
        renderClientsTable();
        renderInvoicesTable();
        renderPaymentsTable();
        renderContractsTable();
    }

    function renderClientsTable() {
        clientsTableBody.innerHTML = '';
        const searchTerm = clientSearchClients.value.toLowerCase();

        const filteredClients = state.clients.filter(client => {
            const matchesName = client.name.toLowerCase().includes(searchTerm);
            const matchesId = String(client.id).includes(searchTerm);
            return matchesName || matchesId;
        });

        filteredClients.forEach(client => {
            const row = document.createElement('tr');
            row.dataset.clientId = client.id;
            const situacao = client.situacao || 'A';
            row.innerHTML = `
                <td>${client.id}</td>
                <td>${client.name}</td>
                <td>+258 ${client.contact}</td>
                <td>${new Date(client.connectionDate + 'T00:00:00').toLocaleDateString()}</td>
                <td>
                    <select class="situacao-select" data-client-id="${client.id}" title="A: Aberto, F: Fechada, N: Não">
                        <option value="A" ${situacao === 'A' ? 'selected' : ''}>A</option>
                        <option value="F" ${situacao === 'F' ? 'selected' : ''}>F</option>
                        <option value="N" ${situacao === 'N' ? 'selected' : ''}>N</option>
                    </select>
                </td>
                <td class="actions-cell">
                    <button class="action-toggle btn-secondary">Ações</button>
                    <div class="action-buttons">
                        <button class="btn-warning" data-action="edit" data-id="${client.id}">Editar</button>
                        <button class="btn-danger" data-action="delete" data-id="${client.id}">Remover</button>
                    </div>
                </td>
            `;
            clientsTableBody.appendChild(row);
        });
    }

    function renderInvoicesTable() {
        invoicesTableBody.innerHTML = '';
        const searchTerm = invoiceSearch.value.toLowerCase(); // Get the search term

        state.clients.forEach((client, index) => {
            const invoice = state.invoices[client.id] || { prevReading: 0, currentReading: 0, debt: 0, customAmount: null };
            const { consumption, totalToPay } = calculateInvoiceTotals(client.id);
            const isFechadoOuNao = client.situacao === 'F' || client.situacao === 'N';
            const leituraAttrs = isFechadoOuNao ? 'class="read-only-input"' : 'contenteditable="true"';
            const leituraTitle = isFechadoOuNao ? `Não editável (Situação: ${client.situacao})` : 'Insira a nova leitura aqui';

            // Filter logic for invoices table
            const matchesName = client.name.toLowerCase().includes(searchTerm);
            const matchesId = String(client.id).includes(searchTerm);
            
            if (matchesName || matchesId) { // Only render if it matches the search term
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td> <td>${client.name}</td>
                    <td data-client-id="${client.id}" data-field="prevReading" class="${isFechadoOuNao ? 'read-only-input' : ''}">${invoice.prevReading || 0}</td>
                    <td ${leituraAttrs} data-client-id="${client.id}" data-field="currentReading" title="${leituraTitle}">${invoice.currentReading || ''}</td>
                    <td class="read-only-input">${consumption}</td>
                    <td contenteditable="true" data-client-id="${client.id}" data-field="debt">${(invoice.debt || 0).toFixed(2)}</td>
                    <td contenteditable="true" data-client-id="${client.id}" data-field="customAmount" title="Pode ser editado manualmente">${totalToPay.toFixed(2)}</td>
                `;
                invoicesTableBody.appendChild(row);
            }
        });
    }

    function renderPaymentsTable() {
        paymentsTableBody.innerHTML = '';
        const searchTerm = clientSearchPayments.value.toLowerCase();

        const filteredClients = state.clients.filter(client => {
            const matchesName = client.name.toLowerCase().includes(searchTerm);
            const matchesId = String(client.id).includes(searchTerm);
            return matchesName || matchesId;
        });

        filteredClients.forEach(client => {
            const { totalToPay } = calculateInvoiceTotals(client.id);
            const payment = state.payments[client.id] || { p1: { amount: 0, date: null }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } };
            const totalPaid = (payment.p1.amount || 0) + (payment.p2.amount || 0) + (payment.p3.amount || 0);
            const remaining = totalToPay - totalPaid;

            const row = document.createElement('tr');
            const formatDate = (dateString) => {
                if (!dateString) return '';
                return new Date(dateString).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            };

            row.innerHTML = `
                <td>${client.name}</td>
                <td class="read-only-input">${totalToPay.toFixed(2)}</td>
                <td class="payment-cell" data-client-id="${client.id}" data-field="p1">
                    <div class="payment-cell-value" title="Clique para editar">${payment.p1.amount || 0}</div>
                    <span class="payment-date">${formatDate(payment.p1.date)}</span>
                </td>
                <td class="payment-cell" data-client-id="${client.id}" data-field="p2">
                    <div class="payment-cell-value" title="Clique para editar">${payment.p2.amount || 0}</div>
                     <span class="payment-date">${formatDate(payment.p2.date)}</span>
                </td>
                <td class="payment-cell" data-client-id="${client.id}" data-field="p3">
                    <div class="payment-cell-value" title="Clique para editar">${payment.p3.amount || 0}</div>
                     <span class="payment-date">${formatDate(payment.p3.date)}</span>
                </td>
                <td class="${remaining > 0 ? 'text-danger' : 'text-success'} read-only-input">${remaining.toFixed(2)}</td>
                <td><button class="btn-primary" data-action="generate-receipt" data-id="${client.id}">Gerar</button></td>
            `;
            paymentsTableBody.appendChild(row);
        });
    }

    function renderContractsTable() {
        contractsTableBody.innerHTML = '';
        Object.keys(state.contracts).forEach(contractId => {
            const contract = state.contracts[contractId];
            const client = state.clients.find(c => c.id == contract.clientId);
            if (!client) return; // Should not happen if data is consistent

            const { totalPaid, remaining } = calculateContractTotals(contractId);

            const row = document.createElement('tr');
            const formatDate = (dateString) => {
                if (!dateString) return '';
                return new Date(dateString).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            };

            row.innerHTML = `
                <td>${contract.id}</td>
                <td>${client.id}</td>
                <td>${client.name}</td>
                <td>${contract.value.toFixed(2)}</td>
                <td class="payment-cell" data-contract-id="${contractId}" data-field="p1">
                    <div class="payment-cell-value" title="Clique para editar">${contract.payments.p1.amount || 0}</div>
                    <span class="payment-date">${formatDate(contract.payments.p1.date)}</span>
                </td>
                <td class="payment-cell" data-contract-id="${contractId}" data-field="p2">
                    <div class="payment-cell-value" title="Clique para editar">${contract.payments.p2.amount || 0}</div>
                    <span class="payment-date">${formatDate(contract.payments.p2.date)}</span>
                </td>
                <td class="payment-cell" data-contract-id="${contractId}" data-field="p3">
                    <div class="payment-cell-value" title="Clique para editar">${contract.payments.p3.amount || 0}</div>
                    <span class="payment-date">${formatDate(contract.payments.p3.date)}</span>
                </td>
                <td class="${remaining > 0 ? 'text-danger' : 'text-success'} read-only-input">${remaining.toFixed(2)}</td>
                <td class="actions-cell">
                    <button class="btn-danger" data-action="delete-contract" data-id="${contractId}">Remover</button>
                </td>
            `;
            contractsTableBody.appendChild(row);
        });
    }

    function renderReceipts() {
        receiptsContainer.innerHTML = '';
        const generatedInvoiceNumbers = new Set();

        const now = new Date();
        const monthName = now.toLocaleString('pt-BR', { month: 'long' }).toUpperCase();
        const year = now.getFullYear();

        const clientsToPrint = state.clients.filter(client => client.situacao === 'A');

        clientsToPrint.forEach((client, index) => {
            let invoiceNumber;
            do {
                invoiceNumber = Math.floor(Math.random() * 9000000000) + 1000000000;
            } while (generatedInvoiceNumbers.has(invoiceNumber));
            generatedInvoiceNumbers.add(invoiceNumber);

            const invoice = state.invoices[client.id] || { prevReading: 0, currentReading: 0, debt: 0, customAmount: null };
            const payment = state.payments[client.id] || { p1: { amount: 0 }, p2: { amount: 0 }, p3: { amount: 0 } };
            const { totalToPay } = calculateInvoiceTotals(client.id);
            const totalPaid = (payment.p1.amount || 0) + (payment.p2.amount || 0) + (payment.p3.amount || 0);
            const valorEmFalta = totalToPay - totalPaid;
            const debtForReceipt = valorEmFalta.toFixed(2);
            const prevReadingForReceipt = invoice.prevReading || 0;
            const counterNumber = String(index + 1).padStart(3, '0');

            const receiptHTML = `
            <div class="receipt">
                <div class="receipt-header">
                    <h4>ÁGUA PAZ (TEMBE)</h4>
                    <p>COMPROVATIVO DE PAGAMENTO PELO CONSUMO DE ÁGUA</p>
                </div>
                <div class="receipt-body">
                    <p>
                        <strong>FACTURA Nº</strong><span class="data-field">${invoiceNumber}</span>
                        <strong>MÊS DE</strong><span class="data-field">${monthName}</span>
                        <strong>ANO</strong><span class="data-field">${year}</span>
                        <strong>CONTADOR Nº</strong><span class="data-field">${counterNumber}</span>
                    </p>
                    <p>
                        Para efeitos e fins julgados convenientes, declaramos que a fatura do(a) Sr(a).<span class="data-field">${client.name}</span>
                        residente na casa nº <span class="data-field">___________</span>
                        tem de pagar a quantia de <span class="data-field">__________</span> MZN
                        o valor do consumo mínimo é de 375MZN.
                    </p>
                    <table>
                        <thead>
                            <tr>
                                <th>LEITURA ANTERIOR</th>
                                <th>LEITURA MENSAL</th>
                                <th>LEITURA TOTAL</th>
                                <th>VALOR POR M³</th>
                                <th colspan="2">VALOR A PAGAR</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="data-field">${prevReadingForReceipt}</span></td>
                                <td><span class="data-field"></span></td>
                                <td><span class="data-field"></span></td>
                                <td><span class="data-field">75.00 MZN</span></td>
                                <td>Leitura</td>
                                <td><span class="data-field"></span> MZN</td>
                            </tr>
                            <tr>
                                <td colspan="4"></td>
                                <td>Dívida</td>
                                <td><span class="data-field">${debtForReceipt} MZN</span></td>
                            </tr>
                            <tr>
                                <td colspan="4"></td>
                                <td><strong>Total</strong></td>
                                <td><strong><span class="data-field"></span> MZN</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="receipt-footer">
                </div>
            </div>`;
            receiptsContainer.innerHTML += receiptHTML;

            if (index < clientsToPrint.length - 1) {
                receiptsContainer.innerHTML += '<hr class="invoice-divider">';
            }
        });
    }

    // Function to convert number to words in Portuguese (simplified for common use)
    function numberToWords(num) {
        const units = ['', 'um', 'dois', 'três', 'quatro', 'cinco', 'seis', 'sete', 'oito', 'nove'];
        const teens = ['dez', 'onze', 'doze', 'treze', 'catorze', 'quinze', 'dezasseis', 'dezassete', 'dezoito', 'dezanove'];
        const tens = ['', '', 'vinte', 'trinta', 'quarenta', 'cinquenta', 'sessenta', 'setenta', 'oitenta', 'noventa'];
        const hundreds = ['', 'cento', 'duzentos', 'trezentos', 'quatrocentos', 'quinhentos', 'seiscentos', 'setecentos', 'oitocentos', 'novecentos'];

        function convertGroup(n) {
            if (n === 0) return '';
            if (n < 10) return units[n];
            if (n >= 10 && n < 20) return teens[n - 10];
            if (n >= 20 && n < 100) {
                return tens[Math.floor(n / 10)] + (n % 10 === 0 ? '' : ' e ' + units[n % 10]);
            }
            if (n >= 100 && n < 1000) {
                if (n === 100) return 'cem';
                return hundreds[Math.floor(n / 100)] + (n % 100 === 0 ? '' : ' e ' + convertGroup(n % 100));
            }
            return '';
        }

        if (num === 0) return 'zero';

        let integerPart = Math.floor(num);
        let decimalPart = Math.round((num - integerPart) * 100);

        let result = '';
        let hundredsGroup = Math.floor(integerPart % 1000);
        let thousandsGroup = Math.floor((integerPart / 1000) % 1000);
        let millionsGroup = Math.floor((integerPart / 1000000) % 1000);
        let billionsGroup = Math.floor(integerPart / 1000000000);

        if (billionsGroup > 0) {
            result += convertGroup(billionsGroup) + ' mil milhões ';
        }
        if (millionsGroup > 0) {
            result += convertGroup(millionsGroup) + (millionsGroup === 1 ? ' milhão ' : ' milhões ');
        }
        if (thousandsGroup > 0) {
            result += (thousandsGroup === 1 && millionsGroup === 0) ? 'mil ' : convertGroup(thousandsGroup) + ' mil ';
        }
        if (hundredsGroup > 0 || (integerPart === 0 && decimalPart === 0)) {
            result += convertGroup(hundredsGroup);
        }
        
        let fullResult = result.trim();
        
        // Add "Metical" or "Meticais" based on the integer part
        if (integerPart === 1 && !fullResult.includes("milhão") && !fullResult.includes("mil milhões")) {
            fullResult += ' Metical';
        } else if (integerPart > 0) {
            fullResult += ' Meticais';
        }

        if (decimalPart > 0) {
            const decimalWords = convertGroup(decimalPart);
            const separator = fullResult ? ' e ' : '';
            fullResult += separator + decimalWords + (decimalPart === 1 ? ' centavo' : ' centavos');
        }

        return fullResult.charAt(0).toUpperCase() + fullResult.slice(1);
    }

    // Function to generate a unique 25-digit binary string
    function generateUniqueBinarySignature() {
        let binaryString;
        do {
            binaryString = '';
            for (let i = 0; i < 25; i++) { // Changed to 25 digits
                binaryString += Math.round(Math.random());
            }
        } while (generatedBinarySignatures.has(binaryString));
        generatedBinarySignatures.add(binaryString);
        return binaryString;
    }


    function generateReceipt(clientId) {
        const client = state.clients.find(c => c.id == clientId);
        if (!client) {
            alert("Cliente não encontrado.");
            return;
        }

        const payment = state.payments[clientId] || { p1: { amount: 0, date: null }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } };
        const { totalToPay } = calculateInvoiceTotals(clientId);
        const totalPaid = (payment.p1.amount || 0) + (payment.p2.amount || 0) + (payment.p3.amount || 0);
        const valorEmFalta = totalToPay - totalPaid;

        // Determine the last payment and its amount
        let lastPaymentAmount = 0;
        let lastPaymentDate = null;
        if (payment.p3.amount > 0 && payment.p3.date) {
            lastPaymentAmount = payment.p3.amount;
            lastPaymentDate = new Date(payment.p3.date);
        } else if (payment.p2.amount > 0 && payment.p2.date) {
            lastPaymentAmount = payment.p2.amount;
            lastPaymentDate = new Date(payment.p2.date);
        } else if (payment.p1.amount > 0 && payment.p1.date) {
            lastPaymentAmount = payment.p1.amount;
            lastPaymentDate = new Date(payment.p1.date);
        }

        const now = lastPaymentDate || new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const monthText = now.toLocaleString('pt-BR', { month: 'long' }).toUpperCase();
        const fullYear = String(now.getFullYear());

        const amountInWords = numberToWords(lastPaymentAmount); // Now includes "Meticais" suffix

        // This function will add underscores only if the content is shorter than maxLength
        const fillWithUnderscores = (text, maxLength) => {
            const currentLength = String(text).length;
            if (currentLength >= maxLength) return String(text);
            return String(text) + '_'.repeat(maxLength - currentLength);
        };

        // This function adds a class to hide the border if the text fills the space
        const getUnderlineClass = (text, maxLength) => {
            // For strings with underscores, we want the underline to show if it's shorter
            // For data like signature that shouldn't have underline if not filled, use a specific check
            return String(text).length >= maxLength ? 'no-underline' : '';
        };

        const machineSignature = generateUniqueBinarySignature();

        // Determine the color class for 'valorEmFalta'
        const valorEmFaltaClass = valorEmFalta > 1499 ? 'data-field-red' : 'data-field-blue';

        // Function to generate a single receipt's HTML
        const createSingleReceiptHTML = () => {
            return `
            <div class="recibo-popup">
                <div class="cabecalho">
                  <div class="agua-paz">ÁGUA PAZ (TEMBE)</div>
                  <div class="recibo-num"> <span class="fill-underline ${getUnderlineClass(day, 2)} data-field-blue">${fillWithUnderscores(day, 2)}</span> DE <span class="fill-underline no-underline-month ${getUnderlineClass(monthText, 10)} data-field-blue">${fillWithUnderscores(monthText, 10)}</span> DE <span class="fill-underline ${getUnderlineClass(fullYear, 4)} data-field-blue">${fullYear}</span> <br /><br />PAGO <span class="fill-underline ${getUnderlineClass(lastPaymentAmount.toFixed(2), 10)} data-field-blue">${fillWithUnderscores(lastPaymentAmount.toFixed(2), 10)}</span> MT</div>
                </div>

                <div class="linha">Recebemos do Exmo Sr.(a). <span class="fill-underline ${getUnderlineClass(client.name, 60)} data-field-blue" style="width: 70%;">${fillWithUnderscores(client.name, 60)}</span></div>
                <div class="linha">a importância de <span class="fill-underline ${getUnderlineClass(amountInWords, 60)} data-field-blue" style="width: 70%;">${fillWithUnderscores(amountInWords, 60)}</span></div>
                <div class="linha"><span class="fill-underline no-underline" style="width: 98%;"></span></div> <div class="linha">referente <span class="fill-underline ${getUnderlineClass('Pagamento de Consumo de Água', 50)} data-field-blue" style="width: 50%;">Pagamento de Consumo de Água</span> Remanescente <span class="fill-underline ${getUnderlineClass(valorEmFalta.toFixed(2), 10)} ${valorEmFaltaClass}">${fillWithUnderscores(valorEmFalta.toFixed(2), 10)}</span> MT</div>

                <div class="linha">de que passamos o presente recibo.</div>

                <div class="linha"></div>

                <div class="receipt-top-info">
                  <span class="payment-form-header">Forma de pagamento:</span>
                  <span class="assinatura-header">Assinatura e carimbo:</span>
                </div>

                <div class="assinatura-checklist-container">
                  <div class="checklist">
                    <label><input type="checkbox"> Cheque nº <span class="fill-underline" style="width: 15ch;"></span></label><br>
                    <label><input type="checkbox"> Banco <span class="fill-underline" style="width: 18ch;"></span></label><br>
                    <label><input type="checkbox"> Outros</label><br>
                    <label><input type="checkbox" checked> Em numerário</label>
                  </div>

                  <div class="assinatura">
                    <span class="fill-underline" style="width: 25ch;"></span>
                    <img src="carimbo.png" alt="Carimbo" class="carimbo-overlay">
                    <br> <br> ASSINATURA MÁQUINA <br /> <br><span class="fill-underline no-underline data-field-blue">${machineSignature}</span>
                  </div>
                </div>
              </div>
            `;
        };

        const newWindow = window.open('', '_blank', 'width=800,height=600');
        newWindow.document.open();
        newWindow.document.write(`
        <!DOCTYPE html>
        <html lang="pt">
        <head>
          <meta charset="UTF-8">
          <title>Recibos de Pagamento</title>
          <style>
            @media print {
              body {
                margin: 0;
                padding: 0;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                height: 29.7cm; /* A4 height */
                width: 21cm; /* A4 width */
                overflow: hidden; /* Hide scrollbars */
              }
              .recibo-popup {
                  width: 21cm !important; /* Largura total da folha A4 */
                  height: 12.8cm !important; /* Altura calculada para dois recibos na A4 (29.7cm / 2 = 14.85cm. Ajustado para caber com pequenas margens) */
                  margin: 0.8cm 0 0.4cm !important; /* Margem superior, sem margens laterais, e inferior reduzida */
                  border: 1px solid black !important;
                  box-sizing: border-box !important;
                  font-family: monospace !important;
                  position: relative !important;
                  page-break-after: auto !important; /* CRÍTICO: Não forçar quebras de página após CADA recibo na nova janela */
                  page-break-inside: avoid; /* Prevent breaking a receipt in half */
              }
              
               /* Ajustar os tamanhos de fonte para o recibo ficar mais compacto na impressão */
              .recibo-popup .cabecalho .agua-paz {
                  font-size: 16pt;
              }
              .recibo-popup .cabecalho .recibo-num {
                  font-size: 12pt;
              }
              .recibo-popup .linha {
                  font-size: 10pt;
                  line-height: 1.2;
              }
              .recibo-popup .checklist label {
                  font-size: 9pt;
              }
              .recibo-popup .assinatura-maquina {
                  font-size: 11pt;
              }
               .carimbo-overlay {
                    top: -35px !important; /* Ajuste a posição vertical do carimbo para impressão */
                    margin-left: 55px !important; /* Ajuste a posição horizontal do carimbo para impressão */
                    width: 150px !important; /* Pode ser necessário ajustar o tamanho do carimbo */
                }
            /* Estilo da nova linha HR para impressão */
            .receipt-divider-print {
                border: none;
                border-top: 1px dashed #999; /* Linha tracejada suave */
                margin: 0.4cm auto !important; /* Margem para separar os recibos */
                width: 80% !important; /* Largura da linha divisória */
                display: block !important; /* Garante que a linha é visível na impressão */
            }

            /* Outros ajustes finos para tabelas dentro do recibo, se aplicável */
            .receipt-body table {
                font-size: 8pt !important;
                margin-top: 0.3cm !important; /* Reduzir a margem superior da tabela */
            }
            .receipt-body table th,
            .receipt-body table td {
                padding: 0.15cm !important; /* Reduzir padding das células da tabela */
                border: 1px solid #333 !important;
            }
            .receipt-footer {
                font-size: 8pt !important;
                margin-top: 0.3cm !important;
                padding-top: 0.15cm !important;
            }
            .receipt-footer p {
                margin-bottom: 0 !important;
            }
            /* Explicitly set for print to ensure row layout */
            .recibo-popup .assinatura-checklist-container {
                flex-direction: row !important; /* Force side-by-side for print */
                justify-content: space-between !important;
                align-items: flex-start !important;
            }
            .recibo-popup .checklist,
            .recibo-popup .assinatura {
                width: 48% !important; /* Ensure they share space */
                margin-bottom: 0 !important;
            }
            .recibo-popup .assinatura {
                text-align: right !important; /* Align signature text to the right for print */
            }

            /* Novo estilo para o topo da seção de pagamento/assinatura no recibo de impressão */
            .recibo-popup .receipt-top-info {
                display: flex !important;
                justify-content: space-between !important;
                align-items: flex-end !important; /* Alinhar texto com a parte de baixo */
                font-weight: bold !important;
                font-size: 10pt !important; /* Ajuste o tamanho da fonte para impressão */
                margin-bottom: 5px !important; /* Espaço entre o cabeçalho e os checkboxes */
            }

            .recibo-popup .receipt-top-info .assinatura-header-print {
                margin-top: 0 !important; /* Remover margem extra no topo */
                margin-bottom: 0 !important; /* Remover margem extra no rodapé */
            }
        }

            /* Estilos de tela para a janela de recibo */
            .recibo-popup {
              width: 97%;
              height: 45%; 
              border: 1px solid black;
              padding: 20px;
              box-sizing: border-box;
              font-family: monospace;
              position: relative;
            }

            .recibo-popup .cabecalho {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            }

            .recibo-popup .agua-paz {
              font-size: 20px;
              font-weight: bold;
              text-transform: uppercase;
            }

            .recibo-popup .recibo-num {
              font-size: 16px;
              text-align: right;
            }

            .recibo-popup .linha {
              margin: 10px 0;
            }

            .recibo-popup .assinatura {
              margin-top: 10px;
              text-align: right;
              position: relative;
            }
            /* Estilo para o texto "Assinatura e carimbo" */
            .recibo-popup .assinatura .assinatura-header {
                font-weight: bold; /* Deixar o texto em negrito */
                font-size: 1rem; /* Pode ajustar o tamanho da fonte */
            }


            .recibo-popup .assinatura-maquina {
              margin-top: 30px;
              font-size: 14px;
            }

            .recibo-popup .checklist {
              margin-top: 10px;
              text-align: left;
            }
            /* Estilo para o texto "Forma de pagamento" */
            .recibo-popup .checklist .payment-form-header {
                font-weight: bold; /* Deixar o texto em negrito */
                font-size: 1rem; /* Pode ajustar o tamanho da fonte */
            }


            .recibo-popup .assinatura-checklist-container {
              display: flex;
              flex-direction: column; /* Stack on small screens for the pop-up too */
              justify-content: space-between;
              align-items: flex-start;
              margin-top: 30px;
            }

            .recibo-popup .checklist,
            .recibo-popup .assinatura {
              width: 100%; /* Full width on small screens for pop-up */
              margin-bottom: 20px;
            }
            .recibo-popup .assinatura {
                text-align: left; /* Align left when stacked */
            }

            /* Novo estilo para o topo da seção de pagamento/assinatura no recibo */
            .recibo-popup .receipt-top-info {
                display: flex;
                justify-content: space-between;
                align-items: flex-end; /* Alinhar o texto com a parte de baixo */
                margin-bottom: 10px; /* Espaço entre o cabeçalho e os checkboxes */
                font-weight: bold; /* Deixar o texto em negrito */
            }
            .recibo-popup .receipt-top-info .assinatura-header {
                margin-top: 0;
                margin-bottom: 0;
            }


            .fill-underline {
                font-family: monospace;
                white-space: pre;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 50px;
                border-bottom: 1px solid black;
                box-sizing: border-box;
                padding: 0 2px;
            }
            .fill-underline.no-underline {
                border-bottom: none;
                text-decoration: none;
            }
            .data-field-blue {
                color: blue;
            }
            .data-field-red {
                color: red;
            }
            .no-underline-month {
                text-decoration: none !important;
                border-bottom: none !important;
            }
            .carimbo-overlay {
                position: absolute;
                top: -42.8px;
                left: 50%;
                transform: translateX(-50%);
                width: 170px;
                height: auto;
                opacity: 0.8;
                z-index: 10;
                margin-left: 64.26px;
            }
            /* Adjustments for the carimbo in the popup, especially if .recibo-popup .assinatura is text-align: left */
            @media (max-width: 768px) {
                .carimbo-overlay {
                    top: auto !important; /* Reset top */
                    bottom: -20px; /* Position relative to signature area */
                    left: 10px !important; /* Align left with text */
                    transform: translateX(0) !important;
                    width: 100px !important; /* Smaller stamp */
                    margin-left: 0 !important;
                }
            }
          </style>
        </head>
        <body>
          ${createSingleReceiptHTML()}
          <hr class="receipt-divider-print"> ${createSingleReceiptHTML()} </body>
        </html>
        `);
        newWindow.document.close();
        newWindow.focus();
        newWindow.print(); // Auto-print
    }


    // --- LÓGICA DE EVENTOS ---
    menuButton.addEventListener('click', () => sideMenu.classList.toggle('open'));

    authForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (verificationCodeInput.value === FIXED_VERIFICATION_CODE) {
            authSection.classList.add('hidden');
            adminActions.classList.remove('hidden');
        } else {
            alert('Código de verificação incorreto!');
        }
        verificationCodeInput.value = '';
    });

    adminActions.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        const action = e.target.dataset.action;
        const view = e.target.dataset.view;

        if (action === 'add-client') {
            clientModalTitle.textContent = 'Adicionar Cliente';
            clientForm.reset();
            clientIdInput.value = '';
            clientModal.classList.remove('hidden');
        } else if (action === 'add-contract') {
            openContractModal();
        }
        
        if (view) {
            views.forEach(v => v.classList.add('hidden'));
            document.getElementById(view).classList.remove('hidden');
            sideMenu.classList.remove('open');
            if (view === 'clients-view') renderClientsTable();
            if (view === 'invoices-view') renderInvoicesTable();
            if (view === 'payments-view') renderPaymentsTable();
            if (view === 'contracts-view') renderContractsTable();
            if (view === 'receipts-view') renderReceipts();
        }
    });

    closeClientModalButton.addEventListener('click', () => clientModal.classList.add('hidden'));
    clientModal.addEventListener('click', (e) => {
        if (e.target === clientModal) clientModal.classList.add('hidden');
    });

    clientForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = clientIdInput.value;
        const clientData = {
            name: clientNameInput.value,
            contact: clientContactInput.value,
            connectionDate: clientConnectionDateInput.value,
        };
        requestVerificationCode(() => {
            if (id) {
                const index = state.clients.findIndex(c => c.id == id);
                if (index > -1) {
                    state.clients[index] = { ...state.clients[index], ...clientData };
                }
            } else {
                const newId = state.clients.length > 0 ? Math.max(...state.clients.map(c => c.id)) + 1 : 1;
                state.clients.push({ id: newId, ...clientData, situacao: 'A' });
                state.invoices[newId] = { prevReading: 0, currentReading: 0, debt: 0, customAmount: null };
                state.payments[newId] = { p1: { amount: 0, date: null }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } };
            }
            saveData();
            renderAllTables();
            clientModal.classList.add('hidden');
        });
    });

    clientsTableBody.addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList.contains('action-toggle')) {
            target.nextElementSibling.classList.toggle('visible');
            return;
        }
        const action = target.dataset.action;
        const id = target.dataset.id;
        if (!action || !id) return;
        if (action === 'edit') {
            const client = state.clients.find(c => c.id == id);
            if (client) {
                clientModalTitle.textContent = 'Editar Cliente';
                clientIdInput.value = client.id;
                clientNameInput.value = client.name;
                clientContactInput.value = client.contact;
                clientConnectionDateInput.value = client.connectionDate;
                clientModal.classList.remove('hidden');
            }
        } else if (action === 'delete') {
            if (confirm(`Tem a certeza que deseja remover o cliente #${id}? Esta ação não pode ser desfeita.`)) {
                requestVerificationCode(() => {
                    state.clients = state.clients.filter(c => c.id != id);
                    delete state.invoices[id];
                    delete state.payments[id];
                    // Also delete related contracts
                    for (const contractId in state.contracts) {
                        if (state.contracts[contractId].clientId == id) {
                            delete state.contracts[contractId];
                        }
                    }
                    saveData();
                    renderAllTables();
                });
            }
        }
    });

    paymentsTableBody.addEventListener('click', (e) => {
        const target = e.target;
        if (target.dataset.action === 'generate-receipt') {
            const clientId = target.dataset.id;
            generateReceipt(clientId);
        }
    });


    function handleSituacaoChange(e) {
        const select = e.target;
        if (!select.classList.contains('situacao-select')) return;
        const clientId = select.dataset.clientId;
        const newSituacao = select.value;
        const client = state.clients.find(c => c.id == clientId);
        if (!client) return;
        const originalSituacao = client.situacao || 'A';
        const invoice = state.invoices[clientId] || { prevReading: 0, currentReading: 0, debt: 0, customAmount: null };
        const payment = state.payments[clientId] || { p1: { amount: 0 }, p2: { amount: 0 }, p3: { amount: 0 } };

        requestVerificationCode(() => {
            client.situacao = newSituacao;
            if (newSituacao === 'N') {
                const { totalToPay } = calculateInvoiceTotals(clientId);
                const totalPaid = (payment.p1.amount || 0) + (payment.p2.amount || 0) + (payment.p3.amount || 0);
                const valorEmFalta = totalToPay - totalPaid;
                invoice.prevReading = invoice.currentReading;
                invoice.currentReading = 0; // Reset current reading
                invoice.customAmount = valorEmFalta + 375; // Add minimum payment for remaining debt
                invoice.debt = 0; // Debt is now part of customAmount
            } else if (originalSituacao === 'N' && newSituacao !== 'N') {
                invoice.customAmount = null;
            } else if (newSituacao === 'F') { // If changing to 'F' (Fechada)
                const { totalToPay } = calculateInvoiceTotals(clientId); // Re-calculate based on current invoice state
                const totalPaid = (payment.p1.amount || 0) + (payment.p2.amount || 0) + (payment.p3.amount || 0);
                const valorEmFalta = totalToPay - totalPaid;
                 invoice.prevReading = invoice.currentReading;
                invoice.currentReading = 0; // Reset current reading for closed account
                invoice.customAmount = valorEmFalta; // Final amount to pay for closure, no additional 375
            } else if (originalSituacao === 'F' && newSituacao !== 'F') {
                invoice.customAmount = null; // Remove custom amount if changing from Fechada
            }
            saveData();
            renderAllTables();
        }, () => {
            select.value = originalSituacao;
        });
    }

    function handleCellEdit(e) {
        const cell = e.target.closest('td[contenteditable="true"]');
        if (!cell) return;

        if (e.type === 'focus') {
            originalCellValue = cell.textContent.trim();
        } else if (e.type === 'blur') {
            const newCellValue = cell.textContent.trim();
            if (newCellValue !== originalCellValue) {
                 requestVerificationCode(() => {
                    updateStateFromCell(cell, newCellValue);
                 }, () => {
                    cell.textContent = originalCellValue; // Revert on failure
                 });
            }
        } else if (e.type === 'keydown' && e.key === 'Enter') {
            e.preventDefault();
            cell.blur();
        }
    }

    function updateStateFromCell(cell, value) {
        const clientId = cell.dataset.clientId;
        const field = cell.dataset.field;
        const client = state.clients.find(c => c.id == clientId);
        if (!client || !field) {
            renderAllTables(); // Re-render to revert invalid changes
            return;
        }

        const parsedValue = parseFloat(value.replace(',', '.'));
        if (isNaN(parsedValue)) {
            alert("Por favor, insira um valor numérico válido.");
            renderAllTables(); // Revert
            return;
        }
        
        // Prevent editing readings for 'F' or 'N' clients
        if ((client.situacao === 'F' || client.situacao === 'N') && (field === 'prevReading' || field === 'currentReading')) {
            alert(`Não é possível alterar as leituras de um cliente com a situação "${client.situacao}".`);
            renderAllTables(); // Revert
            return;
        }

        // START: Validation for currentReading not less than prevReading
        if (field === 'currentReading') {
            const currentInvoice = state.invoices[clientId];
            const prevReading = currentInvoice ? (currentInvoice.prevReading || 0) : 0;
            if (parsedValue < prevReading) {
                alert("A leitura atual não pode ser menor que a leitura anterior.");
                renderInvoicesTable(); // Revert to previous value
                return; 
            }
        }
        // END: Validation for currentReading not less than prevReading

        if (['prevReading', 'currentReading', 'debt', 'customAmount'].includes(field)) {
             if (field === 'customAmount') {
                 const { totalToPay } = calculateInvoiceTotals(clientId);
                 // Only update customAmount if it's significantly different from auto-calculated totalToPay
                 state.invoices[clientId].customAmount = (Math.abs(parsedValue - totalToPay) > 0.01) ? parsedValue : null;
             } else {
                state.invoices[clientId][field] = parsedValue;
                 // If reading or debt is changed, customAmount should be reset
                 if(field === 'currentReading' || field === 'debt') {
                    state.invoices[clientId].customAmount = null;
                 }
             }
             renderInvoicesTable();
             renderPaymentsTable();
        }
        saveData();
    }

    function handlePaymentClick(e) {
        const cell = e.target.closest('.payment-cell');
        if (!cell) return;
        const clientId = cell.dataset.clientId;
        const field = cell.dataset.field;
        const payment = state.payments[clientId] || { p1: { amount: 0, date: null }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } };
        const currentAmount = payment[field].amount || 0;

        requestVerificationCode(() => {
            const newAmountStr = prompt(`Insira o novo valor para o ${field.replace('p', '')}º pagamento:`, currentAmount);
            if (newAmountStr === null) return;
            const newAmount = parseFloat(newAmountStr.replace(',', '.'));
            if (isNaN(newAmount)) {
                alert("Valor inválido. Por favor, insira um número.");
                return;
            }

            const { totalToPay } = calculateInvoiceTotals(clientId);
            const paymentsExceptCurrent = Object.keys(payment)
                .filter(key => key !== field)
                .reduce((sum, key) => sum + (payment[key].amount || 0), 0);

            if (paymentsExceptCurrent + newAmount > totalToPay) {
                alert("O total dos pagamentos não pode exceder o valor total a pagar.");
                return;
            }

            payment[field].amount = newAmount;
            payment[field].date = (newAmount > 0) ? new Date().toISOString() : null;
            saveData();
            renderPaymentsTable();
            renderInvoicesTable(); // Re-render invoices to update "Valor a Pagar" if debt was paid
        });
    }

    function handleContractPaymentClick(e) {
        const cell = e.target.closest('.payment-cell');
        if (!cell) return;
        const contractId = cell.dataset.contractId;
        const field = cell.dataset.field; // p1, p2, p3
        const contract = state.contracts[contractId];
        if (!contract) return;

        const currentAmount = contract.payments[field].amount || 0;

        requestVerificationCode(() => {
            const newAmountStr = prompt(`Insira o novo valor para o ${field.replace('p', '')}º pagamento do contrato:`, currentAmount);
            if (newAmountStr === null) return;
            const newAmount = parseFloat(newAmountStr.replace(',', '.'));
            if (isNaN(newAmount)) {
                alert("Valor inválido. Por favor, insira um número.");
                return;
            }

            const paymentsExceptCurrent = Object.keys(contract.payments)
                .filter(key => key !== field)
                .reduce((sum, key) => sum + (contract.payments[key].amount || 0), 0);
            
            // Check if new total payment exceeds contract value
            if (paymentsExceptCurrent + newAmount > contract.value) {
                alert(`O valor total dos pagamentos (${(paymentsExceptCurrent + newAmount).toFixed(2)} MZN) não pode exceder o valor do contrato (${contract.value.toFixed(2)} MZN).`);
                return;
            }

            contract.payments[field].amount = newAmount;
            contract.payments[field].date = (newAmount > 0) ? new Date().toISOString() : null;
            saveData();
            renderContractsTable();
        });
    }

    newMonthButton.addEventListener('click', () => {
        // Validate if all clients with situation 'A' have current readings
        const clientsWithoutCurrentReading = state.clients.filter(client =>
            client.situacao === 'A' && (!state.invoices[client.id] || !state.invoices[client.id].currentReading)
        );

        if (clientsWithoutCurrentReading.length > 0) {
            const clientNames = clientsWithoutCurrentReading.map(c => c.name).join(', ');
            alert(`Não é possível iniciar um novo mês. Os seguintes clientes com situação 'A' não têm leitura atual: ${clientNames}.`);
            return;
        }


        if (confirm("Tem a certeza que deseja iniciar um novo mês? Esta ação irá arquivar os valores atuais e não pode ser desfeita.")) {
            requestVerificationCode(() => {
                state.clients.forEach(client => {
                    const clientId = client.id;
                    const invoice = state.invoices[clientId] || { prevReading: 0, currentReading: 0, debt: 0, customAmount: null };
                    const payment = state.payments[clientId] || { p1: { amount: 0 }, p2: { amount: 0 }, p3: { amount: 0 } };
                    const totalPaid = (payment.p1.amount || 0) + (payment.p2.amount || 0) + (payment.p3.amount || 0);
                    
                    let remainingAmount;
                    const { totalToPay } = calculateInvoiceTotals(clientId); // Re-calculate based on current invoice state
                    remainingAmount = totalToPay - totalPaid;
                    
                    // Update invoice for new month
                    state.invoices[clientId].debt = remainingAmount > 0 ? remainingAmount : 0;
                    state.invoices[clientId].prevReading = invoice.currentReading || 0;
                    state.invoices[clientId].currentReading = 0;
                    state.invoices[clientId].customAmount = null; // Reset custom amount for new month

                    // Reset payments for new month
                    state.payments[clientId] = { p1: { amount: 0, date: null }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } };
                });
                saveData();
                renderAllTables();
                alert('Novo mês iniciado com sucesso! Os valores foram atualizados.');
            });
        }
    });

    printReceiptsButton.addEventListener('click', () => {
        // This button is intentionally made redundant as generateReceipt directly prints.
        alert('Por favor, use o botão "Gerar" na tabela de pagamentos para imprimir os recibos no formato A4.');
    });

    // --- Contratos Logic ---
    function openContractModal(contract = null) {
        contractForm.reset();
        contractIdInput.value = ''; // This will hold clientId for new contract
        contractModalTitle.textContent = 'Adicionar Contrato';
        contractValueInput.value = 5000; // Default value

        // Populate client select
        contractClientSelect.innerHTML = '<option value="">Selecione um cliente</option>';
        state.clients.forEach(client => {
            // Check if client already has a contract
            const hasContract = Object.values(state.contracts).some(c => c.clientId === client.id);
            const option = document.createElement('option');
            option.value = client.id;
            option.textContent = `${client.name} (ID: ${client.id})`;
            if (hasContract) {
                option.disabled = true; // Disable if client already has a contract
                option.textContent += ' (Já tem contrato)';
            }
            contractClientSelect.appendChild(option);
        });

        if (contract) {
            // Edit mode (not currently used based on prompt, but good to have)
            // contractModalTitle.textContent = 'Editar Contrato';
            // contractIdInput.value = contract.id; // This would be the contract ID
            // contractClientSelect.value = contract.clientId;
            // contractClientSelect.disabled = true; // Cannot change client for existing contract
            // contractValueInput.value = contract.value;
        }
        contractModal.classList.remove('hidden');
    }

    closeContractModalButton.addEventListener('click', () => contractModal.classList.add('hidden'));
    contractModal.addEventListener('click', (e) => {
        if (e.target === contractModal) contractModal.classList.add('hidden');
    });

    contractForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const clientId = parseInt(contractClientSelect.value);
        const contractValue = parseFloat(contractValueInput.value);

        if (isNaN(clientId) || !clientId) {
            alert("Por favor, selecione um cliente.");
            return;
        }
        if (isNaN(contractValue) || contractValue <= 0) {
            alert("Por favor, insira um valor de contrato válido.");
            return;
        }

        // Check for duplicate contract for the same client
        const existingContract = Object.values(state.contracts).find(c => c.clientId === clientId);
        if (existingContract) {
            alert("Este cliente já possui um contrato.");
            return;
        }

        requestVerificationCode(() => {
            const newContractId = state.clients.length > 0 ? Math.max(...state.clients.map(c => c.id)) + 1000 : 1000; // Unique ID for contracts
            state.contracts[newContractId] = {
                id: newContractId,
                clientId: clientId,
                value: contractValue,
                payments: {
                    p1: { amount: 0, date: null },
                    p2: { amount: 0, date: null },
                    p3: { amount: 0, date: null }
                }
            };
            saveData();
            renderContractsTable();
            contractModal.classList.add('hidden');
        });
    });

    contractsTableBody.addEventListener('click', (e) => {
        const target = e.target;
        const action = target.dataset.action;
        const contractId = target.dataset.id;
        if (action === 'delete-contract') {
            if (confirm(`Tem a certeza que deseja remover o contrato #${contractId}? Esta ação não pode ser desfeita.`)) {
                requestVerificationCode(() => {
                    delete state.contracts[contractId];
                    saveData();
                    renderContractsTable();
                });
            }
        }
    });


    // --- Event Listeners ---
    clientsTableBody.addEventListener('change', handleSituacaoChange);
    invoicesTableBody.addEventListener('focus', handleCellEdit, true);
    invoicesTableBody.addEventListener('blur', handleCellEdit, true);
    invoicesTableBody.addEventListener('keydown', handleCellEdit);
    paymentsTableBody.addEventListener('click', handlePaymentClick);
    contractsTableBody.addEventListener('click', handleContractPaymentClick); // For contract payments

    // Search input listeners
    clientSearchClients.addEventListener('input', renderClientsTable);
    clientSearchPayments.addEventListener('input', renderPaymentsTable);
    invoiceSearch.addEventListener('input', renderInvoicesTable); // Add event listener for invoice search


    // --- INICIALIZAÇÃO ---
    loadData();
    renderAllTables();
    document.getElementById('clients-view').classList.remove('hidden');
});
</script>
</body>
</html>
