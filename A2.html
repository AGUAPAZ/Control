<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Águas</title>

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --bg-color: #f4f7f6;
            --font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --border-radius: 6px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Estilo Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--dark-color);
            padding-top: 80px; /* Espaço para o cabeçalho fixo */
        }

        #app {
            width: 100%;
            max-width: 1200px;
            padding: 1rem;
            margin: 0 auto; /* Centra o container principal */
            display: flex; /* Use flexbox for main content + sidebar */
            flex-direction: column; /* Default to column for small screens */
        }

        /* Classes de Utilidade */
        .hidden {
            display: none !important;
        }
        .text-danger {
            color: var(--danger-color);
            font-weight: bold; /* Adicionado para maior destaque */
        }
        .text-success {
            color: var(--success-color);
        }

        /* Cabeçalho */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--box-shadow);
            z-index: 1000;
        }
        header h1 {
            font-size: 1.5rem;
            padding-left: 1rem;
        }
        header button {
            margin-right: 1rem;
        }

        /* Botões */
        button, .button {
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        button:hover, .button:hover {
            opacity: 0.9;
        }
        button:active, .button:active {
            transform: scale(0.98);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-warning {
             background-color: var(--warning-color);
             color: var(--dark-color);
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-icon {
            padding: 0.5rem;
            line-height: 1;
        }

        /* Painel de Menu */
        aside {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px; /* Adjusted for smaller screens */
            height: 100%;
            background-color: white;
            box-shadow: var(--box-shadow);
            padding: 60px 1.5rem 1.5rem;
            transform: translateX(-250px); /* Adjusted width */
            transition: transform 0.3s ease-in-out;
            z-index: 1001;
            overflow-y: auto; /* Permite scroll se o menu for grande */
        }
        aside.open {
            transform: translateX(0);
        }
        #admin-actions button {
            display: block;
            width: 100%;
            text-align: left;
            margin-bottom: 1rem;
            background-color: var(--light-color);
        }

        /* Conteúdo Principal e Vistas */
        main section {
            background-color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-top: 1.5rem;
        }
        main h2 {
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 0.5rem;
        }

        /* Tabelas */
        .table-responsive {
            overflow-x: auto; /* Make tables horizontally scrollable on small screens */
            -webkit-overflow-scrolling: touch; /* Smoother scrolling on iOS */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            min-width: 600px; /* Ensure table has a minimum width to enable scrolling */
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        thead th {
            background-color: var(--light-color);
            font-weight: bold;
        }
        /* Efeito Zebra */
        tbody tr:nth-child(even) {
            background-color: #f2f2f2; /* Cor mais escura para linhas pares */
        }
        tbody tr:hover {
            background-color: #e0e0e0; /* Hover effect */
        }

        td[contenteditable="true"] {
            background-color: #fffbe6;
            outline: 1px dashed var(--warning-color);
            cursor: cell;
        }
        .payment-date {
            font-size: 0.75rem;
            color: var(--secondary-color);
            display: block;
            margin-top: 4px;
        }
        .payment-cell-value {
             cursor: pointer;
             display: inline-block;
             padding: 4px;
             border-radius: 4px;
             border: 1px dashed transparent;
             transition: all 0.2s ease-in-out;
        }
        .payment-cell-value:hover {
             background-color: #fffbe6;
             border-color: var(--warning-color);
        }
        .situacao-select {
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            background-color: white;
        }


        /* Ações na Tabela */
        .actions-cell > button {
            margin-right: 5px;
        }
        .actions-cell .action-toggle {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.5rem 1rem;
        }
        .actions-cell .action-buttons {
            display: none;
            margin-top: 5px;
        }
        .actions-cell .action-buttons.visible {
            display: block;
        }
        .actions-cell .action-buttons button {
            display: inline-block;
            width: auto;
            margin-right: 5px;
            padding: 0.5rem;
            font-size: 0.8rem;
            margin-bottom: 5px; /* Added for better stacking on small screens */
        }

        /* Formulários e Inputs */
        form .form-group {
            margin-bottom: 1.5rem;
        }
        form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        input[type="text"], input[type="password"], input[type="date"], input[type="number"], select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        .input-group {
            display: flex;
        }
        .input-group-text {
            padding: 0.75rem;
            background-color: var(--light-color);
            border: 1px solid #ccc;
            border-right: none;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }
        .input-group input {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }
        .read-only-input {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        /* Janela Modal */
        #client-modal, #contract-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem; /* Added padding for small screens */
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 90vh; /* Prevent modal from overflowing on very small screens */
            overflow-y: auto; /* Enable scrolling for modal content if needed */
        }
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--secondary-color);
        }
        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 1.5rem;
        }

        /* Estilos para Recibos */
        .receipt {
            border: 2px solid var(--dark-color);
            padding: 1rem;
            margin-bottom: 2rem;
            font-family: 'Courier New', Courier, monospace;
            background-color: #fff;
            border-radius: var(--border-radius); /* Arredondado */
            box-shadow: var(--box-shadow); /* Sombra */
        }
        .receipt-header {
            text-align: center;
            border-bottom: 1px solid var(--dark-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .receipt-header h4 {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .receipt-body p {
            line-height: 1.8;
        }
        .receipt-body .data-field {
            font-weight: bold;
            display: inline-block;
            padding: 0 0.5rem;
            text-decoration: underline;
            text-underline-offset: 2px;
            min-width: 90px;
        }
        .receipt-body table {
            width: 100%;
            font-size: 0.9rem;
            border-collapse: collapse;
            border: 1px solid var(--dark-color);
        }
        .receipt-body table th,
        .receipt-body table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        thead th {
            background-color: var(--light-color);
            font-weight: bold;
        }
        .receipt-body table tbody tr:hover {
            background-color: #f5f5f5;
        }
        .receipt-body table td[colspan] {
            text-align: right;
            font-weight: bold;
        }
        .receipt-body table .data-field {
             text-decoration: none;
        }
        .receipt-footer {
            margin-top: 1rem;
            padding-top: 0.5rem;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .receipt-footer p {
            margin-bottom: 0; /* CORREÇÃO PARA ECRÃ */
        }

        /* Estilo para a linha que divide as faturas no ecrã */
        .invoice-divider {
            margin: 1cm 0; /* ALTERADO */
            border: none;
            border-top: 2px dashed var(--secondary-color);
        }


        /* --- INÍCIO: ESTILOS DE IMPRESSÃO --- */
        @media print {
            /* 1. Oculta todos os elementos que estão diretamente no <body> */
            body > * {
                display: none !important;
            }

            /* 2. Mostra o contentor da aplicação e o caminho até à secção de recibos */
            #app, main, #receipts-view {
                display: block !important;
            }
            
            /* 3. Remove paddings, margens e sombras para aproveitar a página toda */
            body, #app, main, #receipts-view {
                padding: 0 !important;
                margin: 0 !important;
                background-color: white !important;
                box-shadow: none !important;
                border: none !important;
                color: #000 !important; /* Garante texto preto na impressão */
            }

            /* 4. Oculta o cabeçalho da vista de recibos (que tem o título e o botão) */
            #receipts-view > div:first-of-type {
                display: none !important;
            }

            /* 5. Garante que o container dos recibos está visível e centralizado para impressão */
            #receipts-container {
                display: block !important;
                width: 21cm; /* A4 width */
                margin: 0 auto !important; /* Centraliza na página A4 */
            }

            /* 6. Garante que a linha divisória para a seção de recibos esteja visível na impressão */
            .invoice-divider {
                display: block !important;
                margin: 1cm 0 !important; /* ALTERADO */
                border-top: 2px dashed var(--secondary-color) !important;
            }

            /* 7. Estilo principal para cada recibo na impressão (usado na nova janela de impressão) */
            .recibo-popup {
                width: 21cm !important; /* Largura total da folha A4 */
                height: 11.8cm !important; /* MODIFICADO: Altura ajustada para caber dois por página (12.8cm - 8%) */
                margin: 0.8cm 0 0.4cm !important; /* Margem superior, sem margens laterais, e inferior reduzida */
                border: 1px solid black !important;
                padding: 20px !important; /* Padding do recibo */
                box-sizing: border-box !important;
                font-family: monospace !important;
                position: relative !important;
                page-break-after: auto !important; /* CRÍTICO: Não forçar quebras de página após CADA recibo na nova janela */
                page-break-inside: avoid; /* Prevent breaking a receipt in half */
            }

            /* Se houver mais de 2 recibos, o ideal é que cada par se ajuste */
            /* Para 2 recibos por página, esta regra é fundamental */
            .recibo-popup:nth-child(even) { /* Para o segundo recibo em cada par */
                /* margin-top: 0.8cm !important; */ /* This can be removed, as the general margin and divider will handle spacing */
            }
            
            /* Ajustar os tamanhos de fonte para o recibo ficar mais compacto na impressão */
            .recibo-popup .cabecalho .agua-paz {
                font-size: 15pt; /* MODIFICADO: 16pt -> 15pt */
            }
            .recibo-popup .cabecalho .recibo-num {
                font-size: 11pt; /* MODIFICADO: 12pt -> 11pt */
            }
            .recibo-popup .linha {
                font-size: 9pt; /* MODIFICADO: 10pt -> 9pt */
                line-height: 1.2;
            }
            .recibo-popup .checklist label {
                font-size: 8pt; /* MODIFICADO: 9pt -> 8pt */
            }
            .recibo-popup .assinatura-maquina {
                font-size: 10pt; /* MODIFICADO: 11pt -> 10pt */
            }
            .carimbo-overlay {
                top: 21.7px !important; /* MODIFICADO: Ajuste a posição vertical do carimbo para impressão -35px + 1.5cm (56.7px) */
                left: 50%; /* Centraliza horizontalmente */
                transform: translateX(-50%); /* Ajuste fino para centralizar */
                width: 383px !important; /* ALTERADO: Original 450px - 15% */
                margin-left: 132.3px !important; /* Mover 3.5cm para a direita */
            }

            /* Estilo da nova linha HR para impressão */
            .receipt-divider-print {
                border: none;
                border-top: 1px dashed #999; /* Linha tracejada suave */
                margin: 0.4cm auto !important; /* Margem para separar os recibos */
                width: 80% !important; /* Largura da linha divisória */
                display: block !important; /* Garante que a linha é visível na impressão */
            }

            /* Outros ajustes finos para tabelas dentro do recibo, se aplicável */
            .receipt-body table {
                font-size: 8pt !important;
                margin-top: 0.3cm !important; /* Reduzir a margem superior da tabela */
            }
            .receipt-body table th,
            .receipt-body table td {
                padding: 0.15cm !important; /* Reduzir padding das células da tabela */
                border: 1px solid #333 !important;
            }
            .receipt-footer {
                font-size: 8pt !important;
                margin-top: 0.3cm !important;
                padding-top: 0.15cm !important;
            }
            .receipt-footer p {
                margin-bottom: 0 !important;
            }
            /* Explicitly set for print to ensure row layout */
            .recibo-popup .assinatura-checklist-container {
                flex-direction: row !important; /* Force side-by-side for print */
                justify-content: space-between !important;
                align-items: flex-start !important;
            }
            .recibo-popup .checklist,
            .recibo-popup .assinatura {
                width: 48% !important; /* Ensure they share space */
                margin-bottom: 0 !important;
            }
            .recibo-popup .assinatura {
                text-align: right !important; /* Align signature text to the right for print */
            }

            /* Novo estilo para o topo da seção de pagamento/assinatura no recibo de impressão */
            .recibo-popup .receipt-top-info {
                display: flex !important;
                justify-content: space-between !important;
                align-items: flex-end !important; /* Alinhar texto com a parte de baixo */
                font-weight: bold !important;
                font-size: 9pt !important; /* MODIFICADO: 10pt -> 9pt */
                margin-bottom: 5px !important; /* Espaço entre o cabeçalho e os checkboxes */
            }

            .recibo-popup .receipt-top-info .assinatura-header-print {
                margin-top: 0 !important; /* Remover margem extra no topo */
                margin-bottom: 0 !important; /* Remover margem extra no rodapé */
            }
            
            /* --- INÍCIO DA ALTERAÇÃO: LÓGICA DE IMPRESSÃO 3-POR-PÁGINA --- */
            
            /* A lógica de qual linha divisória mostrar é agora controlada pelo JavaScript.
               Esta secção CSS vai controlar as quebras de página. */

            /* Força uma quebra de página APÓS o terceiro recibo de cada grupo (3º, 6º, 9º, etc.) */
            #receipts-container .receipt:nth-of-type(3n) {
                page-break-after: always;
            }
            
            /* Evita que o último recibo da lista crie uma página em branco desnecessária no final. */
            #receipts-container .receipt:last-of-type {
                page-break-after: auto;
            }

            /* --- FIM DA ALTERAÇÃO --- */
        }
        /* --- FIM: ESTILOS DE IMPRESSÃO --- */

        /* Estilos do Recibo Separado (apenas para visualização em ecrã, será sobrescrito pelo @media print) */
        .recibo-popup {
            width: 97%;
            /* A altura em percentagem para ecrã pode permanecer a mesma, pois é relativa ao viewport */
            height: 45%; 
            border: 1px solid black;
            padding: 20px;
            box-sizing: border-box;
            font-family: monospace;
            position: relative;
        }

        .recibo-popup .cabecalho {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .recibo-popup .agua-paz {
            font-size: 20px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .recibo-popup .recibo-num {
            font-size: 16px;
            text-align: right; /* Align to the right */
        }

        .recibo-popup .linha {
            margin: 10px 0;
        }

        .recibo-popup .assinatura {
            margin-top: 10px;
            text-align: right;
            position: relative; /* Adicionado para posicionamento do carimbo */
        }
        /* Estilo para o texto "Assinatura e carimbo" */
        .recibo-popup .assinatura span {
            font-weight: bold; /* Deixar o texto em negrito */
            font-size: 1rem; /* Pode ajustar o tamanho da fonte */
        }


        .recibo-popup .assinatura-maquina {
            margin-top: 30px;
            font-size: 14px;
        }

        .recibo-popup .checklist {
            margin-top: 10px;
            text-align: left;
        }
        /* Estilo para o texto "Forma de pagamento" */
        .recibo-popup .checklist span.payment-form-header {
            font-weight: bold; /* Deixar o texto em negrito */
            font-size: 1rem; /* Pode ajustar o tamanho da fonte */
        }


        .recibo-popup .assinatura-checklist-container {
            display: flex;
            flex-direction: row; /* Change to row for side-by-side */
            justify-content: space-between; /* Pushes items to the ends */
            align-items: flex-start; /* Aligns them to the top of the container */
            margin-top: 30px;
        }

        .recibo-popup .checklist,
        .recibo-popup .assinatura {
            width: 48%; /* Give them approximately half width to sit side-by-side */
            margin-bottom: 0; /* Remove bottom margin when side-by-side */
        }
        .recibo-popup .assinatura {
            text-align: right; /* Align signature text to the right */
        }

        /* Novo estilo para o topo da seção de pagamento/assinatura no recibo */
        .recibo-popup .receipt-top-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-end; /* Alinhar o texto com a parte de baixo */
            margin-bottom: 10px; /* Espaço entre o cabeçalho e os checkboxes */
            font-weight: bold; /* Deixar o texto em negrito */
        }
        .recibo-popup .receipt-top-info .assinatura-header {
            margin-top: 0;
            margin-bottom: 0;
        }


        .fill-underline {
            font-family: monospace;
            white-space: pre; /* Preserve whitespace for underscores */
            text-decoration: none; /* Remove default underline if any */
            display: inline-flex; /* Use inline-flex for content centering */
            align-items: center; /* Center content vertically */
            justify-content: center; /* Center content horizontally */
            min-width: 50px; /* Minimum width for the filled area */
            border-bottom: 1px solid black; /* Simulate underline with border */
            box-sizing: border-box; /* Include padding/border in width */
            padding: 0 2px; /* Small padding to prevent text from touching border */
        }

        /* New style to hide underscores if data fills the space */
        .fill-underline.no-underline {
            border-bottom: none;
            text-decoration: none;
        }

        /* Custom styles for receipt data */
        .data-field-blue {
            color: blue;
        }
        .data-field-red {
            color: red;
        }
        .data-field-yellow {
            color: orange; /* ALTERADO para laranja */
            font-weight: bold; 
            font-size: 1.05em; /* Aumentado 5% */
        }
        .no-underline-month {
            text-decoration: none !important;
            border-bottom: none !important;
        }

        /* Estilo para a imagem do carimbo */
        .carimbo-overlay {
            position: absolute;
            top: 13.9px; /* MODIFICADO: Posição vertical original -42.8px + 1.5cm (56.7px) */
            left: 50%; /* Centraliza horizontalmente */
            transform: translateX(-50%); /* Ajuste fino para centralizar */
            width: 434px; /* ALTERADO: Original 510px - 15% */
            height: auto;
            opacity: 0.8; /* Opacidade para simular carimbo */
            z-index: 10; /* Garante que fique acima da linha */
            margin-left: 196.56px; /* ALTERADO: Original 64.26px + 132.3px (3.5cm para a direita) */
        }


        /* --- RESPONSIVIDADE --- */

        /* Pequenas telas (smartphones) */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.2rem;
                padding-left: 0.5rem;
            }
            header button {
                margin-right: 0.5rem;
            }
            
            #app {
                padding: 0.5rem;
            }

            main section {
                padding: 1rem;
                margin-top: 1rem;
            }
            
            /* --- INÍCIO ALTERAÇÃO --- */
            /* Ajustar o cabeçalho da vista de recibos para empilhar em telas pequenas */
             #receipts-view .receipts-header-controls {
                flex-direction: column;
                align-items: stretch; /* Fazer os itens ocuparem a largura total */
                gap: 15px; /* Adicionar espaço entre os grupos de controlo */
            }

            #receipts-view .receipts-header-controls .id-range-filter {
                flex-direction: column;
                gap: 8px;
            }

            #receipts-view .receipts-header-controls .id-range-filter input {
                width: 100%; /* Ocupar toda a largura */
            }
            /* --- FIM ALTERAÇÃO --- */

            /* Search input on top of tables */
            #clients-view div, #payments-view div, #invoices-view div {
                flex-direction: column;
                align-items: flex-start;
            }
            #client-search-clients, #client-search-payments, #invoice-search {
                width: 100% !important; /* Override inline style */
                margin-top: 10px;
            }

            /* Adjust button padding and font for smaller screens */
            button, .button {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            .actions-cell .action-buttons button {
                padding: 0.4rem;
                font-size: 0.75rem;
            }

            /* Receipts container */
            #receipts-container {
                padding: 0.5rem;
            }

            .recibo-popup .cabecalho {
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 10px;
            }
            .recibo-popup .recibo-num {
                text-align: left;
                margin-top: 10px;
            }
            .recibo-popup .assinatura-checklist-container {
                flex-direction: column;
                align-items: flex-start;
            }
            .recibo-popup .checklist,
            .recibo-popup .assinatura {
                width: 100%;
                margin-bottom: 15px;
            }
            .recibo-popup .assinatura {
                text-align: left; /* Align signature left when stacked */
            }
            .carimbo-overlay {
                top: auto !important; /* Reset top for mobile view */
                bottom: -76.7px; /* MODIFICADO: Posição relativa -20px - 1.5cm (56.7px) */
                left: 142.3px !important; /* ALTERADO: Original 10px + 132.3px (3.5cm) para a direita */
                transform: translateX(0) !important;
                width: 255px !important; /* ALTERADO: Original 300px - 15% */
                margin-left: 0 !important;
            }
            /* Adjust for stacked layout on small screens */
            .recibo-popup .receipt-top-info {
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 5px;
            }
            .recibo-popup .receipt-top-info .assinatura-header {
                margin-top: 10px; /* Add space when stacked */
            }
        }

        /* Médias telas (tablets) */
        @media (min-width: 769px) and (max-width: 1024px) {
            aside {
                width: 280px;
                transform: translateX(-280px);
            }
            aside.open {
                transform: translateX(0);
            }
            #app {
                padding: 1rem;
            }
            main section {
                padding: 1.2rem;
            }
        }

        /* Telas grandes (desktops) */
        @media (min-width: 1025px) {
            #app {
                display: block; /* Revert to block for desktop */
            }
            aside {
                position: fixed; /* Keep fixed for overlay behavior */
                width: 300px; /* Original width */
                transform: translateX(-300px); /* Original transform */
            }
            aside.open {
                transform: translateX(0);
            }
            /* Restore original flex for signature/checklist for larger screens */
            .recibo-popup .assinatura-checklist-container {
                flex-direction: row;
            }
            .recibo-popup .checklist,
            .recibo-popup .assinatura {
                width: 48%;
                margin-bottom: 0;
            }
            .recibo-popup .assinatura {
                text-align: right;
            }
            .carimbo-overlay {
                top: 13.9px !important; /* MODIFICADO: Posição revertida -42.8px + 1.5cm (56.7px) */
                left: 50% !important; /* Revert to original position */
                transform: translateX(-50%) !important;
                width: 434px !important; /* ALTERADO: Original 510px - 15% */
                margin-left: 196.56px !important; /* ALTERADO: Original 64.26px + 132.3px (3.5cm para a direita) */
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>💧 Gestão de Águas</h1>
        <button id="menu-button" class="btn-primary">Menu</button>
    </header>

    <aside id="side-menu">
        <section id="auth-section">
            <h3>Acesso Restrito</h3>
            <form id="auth-form">
                <div class="form-group">
                    <label for="verification-code">Código de Verificação</label>
                    <input type="password" id="verification-code" required>
                </div>
                <button type="submit" class="btn-primary">Entrar</button>
            </form>
        </section>

        <section id="admin-actions" class="hidden">
            <button data-action="add-client">Adicionar Cliente</button>
            <button data-view="clients-view">Ver Clientes</button>
            <button data-view="invoices-view">Ver Faturas</button>
            <button data-view="payments-view">Ver Pagamentos</button>
            <button data-action="add-contract">Adicionar Contrato</button>
            <button data-view="contracts-view">Ver Contratos</button>
            <button data-view="receipts-view">Gerar Facturas</button>
            
            <hr style="margin: 20px 0;">
            <button data-action="export-data" class="btn-danger">Exportar Dados (Backup)</button>
            <button data-action="import-data" class="btn-danger">Importar Dados (Restaurar)</button>
            <input type="file" id="import-file-input" class="hidden" accept=".json">
        </section>
    </aside>

    <div id="app">
        <main>
            <section id="clients-view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Clientes</h2>
                    <input type="text" id="client-search-clients" placeholder="Pesquisar por nome ou ID..." style="width: 50%;">
                </div>
                <div class="table-responsive">
                    <table id="clients-table">
                        <thead>
                            <tr>
                                <th>Nº Cliente</th>
                                <th>Nome</th>
                                <th>Contacto</th>
                                <th>Data da Ligação</th>
                                <th>Situação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="clients-table-body"></tbody>
                    </table>
                </div>
            </section>

            <section id="invoices-view" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Gestão de Faturas</h2>
                    <input type="text" id="invoice-search" placeholder="Pesquisar por nome ou ID..." style="width: 50%;">
                    <button id="new-month-button" class="btn-warning">🚀 Novo Mês</button>
                </div>
                <div class="table-responsive">
                    <table id="invoices-table">
                        <thead>
                            <tr>
                                <th>Nº</th>
                                <th>Nome Cliente</th>
                                <th>Leitura Anterior (m³)</th>
                                <th>Leitura Atual (m³)</th>
                                <th>Consumo (m³)-</th>
                                <th>Dívida (MZN)</th>
                                <th>Valor a Pagar (MZN)</th>
                            </tr>
                        </thead>
                        <tbody id="invoices-table-body"></tbody>
                    </table>
                </div>
            </section>

            <section id="payments-view" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Gestão de Pagamentos</h2>
                    <input type="text" id="client-search-payments" placeholder="Pesquisar por nome ou ID..." style="width: 50%;">
                </div>
                <div class="table-responsive">
                    <table id="payments-table">
                        <thead>
                            <tr>
                                <th>Nº</th>
                                <th>Nome Cliente</th>
                                <th>Valor Total (MZN)</th>
                                <th>1º Pagamento (MZN)</th>
                                <th>2º Pagamento (MZN)</th>
                                <th>3º Pagamento (MZN)</th>
                                <th>Valor em Falta (MZN)</th>
                                <th>Comprovativo</th>
                            </tr>
                        </thead>
                        <tbody id="payments-table-body"></tbody>
                    </table>
                </div>
            </section>

            <section id="contracts-view" class="hidden">
                <h2>Dívidas Contratuais</h2>
                <div class="table-responsive">
                    <table id="contracts-table">
                        <thead>
                            <tr>
                                <th>Nº Contrato</th>
                                <th>Nº Cliente</th>
                                <th>Nome Cliente</th>
                                <th>Valor Contrato (MZN)</th>
                                <th>1º Pagamento (MZN)</th>
                                <th>2º Pagamento (MZN)</th>
                                <th>3º Pagamento (MZN)</th>
                                <th>Valor em Falta (MZN)</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="contracts-table-body"></tbody>
                    </table>
                </div>
            </section>

            <section id="receipts-view" class="hidden">
                <div class="receipts-header-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap;">
                    <h2>Facturas Geradas</h2>
                    <div class="id-range-filter" style="display: flex; gap: 10px; align-items: center;">
                        <label for="client-start-id">Início ID:</label>
                        <input type="number" id="client-start-id" placeholder="Ex: 1" style="width: 80px;">
                        <label for="client-end-id">Fim ID:</label>
                        <input type="number" id="client-end-id" placeholder="Ex: 10" style="width: 80px;">
                        <button id="generate-receipts-by-range-button" class="btn-primary">Gerar por ID</button>
                    </div>
                    <button id="edit-receipt-order-button" class="btn-secondary">Editar Sequência</button>
                </div>
                <div id="receipts-container">
                </div>
            </section>
        </main>
    </div>

    <div id="client-modal" class="hidden">
        <div class="modal-content">
            <button class="modal-close" id="close-client-modal-button">&times;</button>
            <h3 id="client-modal-title">Adicionar Cliente</h3>
            <form id="client-form">
                <input type="hidden" id="client-id">
                <div class="form-group">
                    <label for="client-name">Nome</label>
                    <input type="text" id="client-name" required>
                </div>
                <div class="form-group">
                    <label for="client-contact">Contacto</label>
                    <div class="input-group">
                        <span class="input-group-text">+258</span>
                        <input type="text" id="client-contact" required pattern="\d{9}" title="Insira um número de 9 dígitos.">
                    </div>
                </div>
                <div class="form-group">
                    <label for="client-connection-date">Data da Ligação</label>
                    <input type="date" id="client-connection-date" required>
                </div>
                <button type="submit" class="btn-success">Salvar</button>
            </form>
        </div>
    </div>

    <div id="contract-modal" class="hidden">
        <div class="modal-content">
            <button class="modal-close" id="close-contract-modal-button">&times;</button>
            <h3 id="contract-modal-title">Adicionar Contrato</h3>
            <form id="contract-form">
                <input type="hidden" id="contract-id">
                <div class="form-group">
                    <label for="contract-client-select">Cliente</label>
                    <select id="contract-client-select" style="width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: var(--border-radius);" required></select>
                </div>
                <div class="form-group">
                    <label for="contract-value">Valor do Contrato (MZN)</label>
                    <input type="number" id="contract-value" value="5000" min="0" step="1" required>
                </div>
                <button type="submit" class="btn-success">Salvar Contrato</button>
            </form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Seletores de elementos do DOM
    const menuButton = document.getElementById('menu-button');
    const sideMenu = document.getElementById('side-menu');
    const authSection = document.getElementById('auth-section');
    const adminActions = document.getElementById('admin-actions');
    const authForm = document.getElementById('auth-form');
    const verificationCodeInput = document.getElementById('verification-code');
    const views = document.querySelectorAll('main > section');

    const clientModal = document.getElementById('client-modal');
    const closeClientModalButton = document.getElementById('close-client-modal-button');
    const clientForm = document.getElementById('client-form');
    const clientModalTitle = document.getElementById('client-modal-title');
    const clientIdInput = document.getElementById('client-id');
    const clientNameInput = document.getElementById('client-name');
    const clientContactInput = document.getElementById('client-contact');
    const clientConnectionDateInput = document.getElementById('client-connection-date');
    const clientsTableBody = document.getElementById('clients-table-body');
    const clientSearchClients = document.getElementById('client-search-clients');

    const invoicesTableBody = document.getElementById('invoices-table-body');
    const invoiceSearch = document.getElementById('invoice-search'); // Added for invoice search
    const paymentsTableBody = document.getElementById('payments-table-body');
    const clientSearchPayments = document.getElementById('client-search-payments');

    const contractsTableBody = document.getElementById('contracts-table-body');
    const contractModal = document.getElementById('contract-modal');
    const closeContractModalButton = document.getElementById('close-contract-modal-button');
    const contractForm = document.getElementById('contract-form');
    const contractModalTitle = document.getElementById('contract-modal-title');
    const contractIdInput = document.getElementById('contract-id'); // Not used for contract ID, but for selected client ID
    const contractClientSelect = document.getElementById('contract-client-select');
    const contractValueInput = document.getElementById('contract-value');

    const receiptsContainer = document.getElementById('receipts-container');
    const newMonthButton = document.getElementById('new-month-button');
    const editReceiptOrderButton = document.getElementById('edit-receipt-order-button');
    const clientStartIdInput = document.getElementById('client-start-id');
    const clientEndIdInput = document.getElementById('client-end-id');
    const generateReceiptsByRangeButton = document.getElementById('generate-receipts-by-range-button');
    
    // NOVO: Seletor para o input de importação de ficheiro
    const importFileInput = document.getElementById('import-file-input');

    // Estado da aplicação
    let state = { clients: [], invoices: {}, payments: {}, contracts: {}, receiptOrder: [] };
    const FIXED_VERIFICATION_CODE = '123456a';
    let originalCellValue = null;
    const generatedBinarySignatures = new Set();

    // --- Lógica de segurança ---
    function requestVerificationCode(onSuccess, onFail = () => {}) {
        const code = prompt("Para realizar esta ação, por favor, insira o código de verificação:");
        if (code === FIXED_VERIFICATION_CODE) {
            onSuccess();
        } else if (code !== null) {
            alert('Código de verificação incorreto!');
            onFail();
        } else {
             onFail(); // User cancelled prompt
        }
    }

    // --- PERSISTÊNCIA ---
    function saveData() {
        localStorage.setItem('waterManagementData', JSON.stringify(state));
    }
    
    // NOVO: Função para exportar os dados para um ficheiro JSON
    function exportDataToFile() {
        try {
            // Converte o estado atual para uma string JSON formatada
            const dataStr = JSON.stringify(state, null, 2);
            // Cria um Blob (Binary Large Object) que representa os dados
            const blob = new Blob([dataStr], { type: 'application/json' });
            // Cria uma URL temporária para o Blob
            const url = URL.createObjectURL(blob);
            
            // Cria um elemento de link <a> invisível
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            
            // Define o nome do ficheiro que será descarregado
            const today = new Date().toISOString().slice(0, 10); // Formato AAAA-MM-DD
            a.download = `backup_gestao_aguas_${today}.json`;
            
            document.body.appendChild(a);
            // Simula um clique no link para iniciar o download
            a.click();
            
            // Limpa a URL e remove o elemento após o download
            URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            alert('Backup dos dados exportado com sucesso!');

        } catch (error) {
            console.error('Erro ao exportar dados:', error);
            alert('Ocorreu um erro ao tentar exportar os dados.');
        }
    }

    // NOVO: Função para importar dados a partir de um ficheiro JSON
    function importDataFromFile(event) {
        const file = event.target.files[0];
        if (!file) {
            return; // Nenhum ficheiro selecionado
        }

        if (!confirm('Tem a certeza que deseja importar este ficheiro? Esta ação irá substituir TODOS os dados atuais e não pode ser desfeita.')) {
            event.target.value = null; // Limpa o input para permitir selecionar o mesmo ficheiro novamente
            return;
        }

        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                const importedState = JSON.parse(content);

                // Validação básica para garantir que o ficheiro tem a estrutura esperada
                if (importedState.clients && importedState.invoices && importedState.payments && importedState.contracts) {
                    state = importedState;
                    saveData(); // Guarda o novo estado no localStorage
                    renderAllTables(); // Re-renderiza todas as tabelas com os novos dados
                    alert('Dados importados com sucesso!');
                } else {
                    throw new Error('Estrutura de dados inválida no ficheiro.');
                }
            } catch (error) {
                console.error('Erro ao importar o ficheiro:', error);
                alert('Erro: O ficheiro selecionado não é um ficheiro de backup válido ou está corrompido.');
            } finally {
                event.target.value = null; // Limpa o input
            }
        };

        reader.onerror = function() {
            alert('Ocorreu um erro ao ler o ficheiro.');
            event.target.value = null; // Limpa o input
        };

        reader.readAsText(file);
    }


    function loadData() {
        const data = localStorage.getItem('waterManagementData');
        if (data) {
            state = JSON.parse(data);
            // Ensure default situacao for old data and correct structure for payments/contracts
            state.clients.forEach(client => {
                if (client.situacao === undefined) {
                    client.situacao = 'A';
                }
            });
            // Ensure payment objects have amount and date for p1, p2, p3
            for (const clientId in state.payments) {
                ['p1', 'p2', 'p3'].forEach(p => {
                    if (state.payments[clientId][p] === undefined) {
                        state.payments[clientId][p] = { amount: 0, date: null };
                    } else if (typeof state.payments[clientId][p] === 'number') { // Convert old number format
                         state.payments[clientId][p] = { amount: state.payments[clientId][p], date: null };
                    }
                });
            }
             // Ensure contract payment objects have amount and date
            for (const contractId in state.contracts) {
                ['p1', 'p2', 'p3'].forEach(p => {
                    if (state.contracts[contractId].payments[p] === undefined) {
                        state.contracts[contractId].payments[p] = { amount: 0, date: null };
                    }
                });
            }
            
            if (!state.receiptOrder || !Array.isArray(state.receiptOrder) || state.receiptOrder.length === 0) {
                 state.receiptOrder = [10, 16, 113, 42, 21, 23, 15, 72, 76, 65, 30, 55, 52, 94, 83, 116, 51, 48, 100, 88, 118, 114, 33, 121, 7, 13, 102, 95, 111, 133, 99, 108, 126, 124, 110, 130, 67, 71, 29, 50, 112, 97, 117, 120, 92, 107, 77, 63, 6, 2, 68, 1, 73, 17, 25, 9, 132, 20, 69, 11, 134, 98, 104, 62, 82, 128, 37, 93, 57, 119, 18, 24, 125, 90, 129, 8, 3, 26, 58, 61, 80, 137, 44];
            }

        } else {
            state = {
                clients: [
                    { id: 1, name: 'António Luís', contact: '841234567', connectionDate: '2023-01-15', situacao: 'A' },
                    { id: 2, name: 'Elias Manue', contact: '867654321', connectionDate: '2023-02-20', situacao: 'A' },
                    { id: 3, name: 'Alberto', contact: '829876543', connectionDate: '2023-03-10', situacao: 'F' }
                ],
                invoices: {
                    1: { prevReading: 5, currentReading: 15, debt: 0, customAmount: null },
                    2: { prevReading: 6, currentReading: 26, debt: 150, customAmount: null },
                    3: { prevReading: 7, currentReading: 7, debt: 525, customAmount: null }
                },
                payments: {
                    1: { p1: { amount: 375, date: '2025-05-26T10:00:00.000Z' }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } },
                    2: { p1: { amount: 600, date: '2025-05-26T11:00:00.000Z' }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } },
                    3: { p1: { amount: 0, date: null }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } }
                },
                contracts: {}, // New empty contracts object
                receiptOrder: [10, 16, 113, 42, 21, 23, 15, 72, 76, 65, 30, 55, 52, 94, 83, 116, 51, 48, 100, 88, 118, 114, 33, 121, 7, 13, 102, 95, 111, 133, 99, 108, 126, 124, 110, 130, 67, 71, 29, 50, 112, 97, 117, 120, 92, 107, 77, 63, 6, 2, 68, 1, 73, 17, 25, 9, 132, 20, 69, 11, 134, 98, 104, 62, 82, 128, 37, 93, 57, 119, 18, 24, 125, 90, 129, 8, 3, 26, 58, 61, 80, 137, 44]
            };
        }
    }

    // --- FUNÇÃO AUXILIAR DE CÁLCULO ---
    function calculateInvoiceTotals(clientId) {
        const invoice = state.invoices[clientId] || { prevReading: 0, currentReading: 0, debt: 0, customAmount: null };
        const client = state.clients.find(c => c.id == clientId);

        let consumption = 0;
        let tariff = 0;
        let totalToPay = 0; // Initialize totalToPay

        if (client && client.situacao === 'F') { // Cliente Fechado: não calcula consumo, apenas dívida
            consumption = 0;
            tariff = 0; // Não há tarifa de consumo para cliente fechado
            totalToPay = parseFloat(invoice.debt) || 0; // Only debt
        } else if (client && client.situacao === 'N') { // Cliente com Situação 'N': não calcula consumo, apenas dívida
            consumption = 0;
            tariff = 0;
            totalToPay = parseFloat(invoice.debt) || 0; // Only debt
        }
        else if (client && client.situacao === 'A' && (invoice.currentReading || 0) === (invoice.prevReading || 0)) {
            // Situation A and Consumption is 0
            consumption = 0;
            tariff = 0;
            totalToPay = (parseFloat(invoice.debt) || 0) + 375; // Debt + 375
        }
        else {
            const hasNewReading = (invoice.currentReading || 0) > 0 && (invoice.currentReading || 0) > (invoice.prevReading || 0);
            consumption = Math.max(0, (invoice.currentReading || 0) - (invoice.prevReading || 0));
            tariff = hasNewReading ? (consumption <= 5 ? 375 : consumption * 75) : 0;
            totalToPay = (parseFloat(invoice.debt) || 0) + tariff; // Debt + tariff
        }

        if (invoice.customAmount != null) {
            totalToPay = parseFloat(invoice.customAmount); // Use custom amount if available
        }

        return { consumption, tariff, totalToPay };
    }

    function calculateContractTotals(contractId) {
        const contract = state.contracts[contractId];
        if (!contract) return { totalPaid: 0, remaining: 0 };

        const totalPaid = (contract.payments.p1.amount || 0) +
                          (contract.payments.p2.amount || 0) +
                          (contract.payments.p3.amount || 0);
        const remaining = contract.value - totalPaid;
        return { totalPaid, remaining };
    }


    // --- RENDERIZAÇÃO ---
    function renderAllTables() {
        renderClientsTable();
        renderInvoicesTable();
        renderPaymentsTable();
        renderContractsTable();
    }

    function renderClientsTable() {
        clientsTableBody.innerHTML = '';
        const searchTerm = clientSearchClients.value.toLowerCase();

        const filteredClients = state.clients.filter(client => {
            const matchesName = client.name.toLowerCase().includes(searchTerm);
            const matchesId = String(client.id).includes(searchTerm);
            return matchesName || matchesId;
        });

        filteredClients.forEach(client => {
            const row = document.createElement('tr');
            row.dataset.clientId = client.id;
            const situacao = client.situacao || 'A';
            row.innerHTML = `
                <td>${client.id}</td>
                <td>${client.name}</td>
                <td>+258 ${client.contact}</td>
                <td>${new Date(client.connectionDate + 'T00:00:00').toLocaleDateString()}</td>
                <td>
                    <select class="situacao-select" data-client-id="${client.id}" title="A: Aberto, F: Fechada, N: Não">
                        <option value="A" ${situacao === 'A' ? 'selected' : ''}>A</option>
                        <option value="F" ${situacao === 'F' ? 'selected' : ''}>F</option>
                        <option value="N" ${situacao === 'N' ? 'selected' : ''}>N</option>
                    </select>
                </td>
                <td class="actions-cell">
                    <button class="action-toggle btn-secondary">Ações</button>
                    <div class="action-buttons">
                        <button class="btn-warning" data-action="edit" data-id="${client.id}">Editar</button>
                        <button class="btn-danger" data-action="delete" data-id="${client.id}">Remover</button>
                        <button class="btn-secondary" data-action="reset-meter" data-id="${client.id}" title="Zerar leituras para simular troca de contador">Trocar Contador</button>
                    </div>
                </td>
            `;
            clientsTableBody.appendChild(row);
        });
    }

    function renderInvoicesTable() {
        invoicesTableBody.innerHTML = '';
        const searchTerm = invoiceSearch.value.toLowerCase(); 

        state.clients.forEach((client, index) => {
            const invoice = state.invoices[client.id] || { prevReading: 0, currentReading: 0, debt: 0, customAmount: null };
            const { consumption, totalToPay } = calculateInvoiceTotals(client.id);
            const isFechadoOuNao = client.situacao === 'F' || client.situacao === 'N';
            
            const prevReadingAttrs = isFechadoOuNao 
                ? `class="read-only-input" title="Não editável (Situação: ${client.situacao})"` 
                : '';
            const currentReadingAttrs = isFechadoOuNao 
                ? `class="read-only-input" title="Não editável (Situação: ${client.situacao})"`
                : `contenteditable="true" title="Insira a nova leitura aqui"`;

            const matchesName = client.name.toLowerCase().includes(searchTerm);
            const matchesId = String(client.id).includes(searchTerm);
            
            if (matchesName || matchesId) { 
                const debtValue = parseFloat(invoice.debt || 0); 
                const debtClass = debtValue > 1124 ? 'text-danger' : '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${client.id}</td>
                    <td>${client.name}</td>
                    <td data-client-id="${client.id}" data-field="prevReading" ${prevReadingAttrs}>${invoice.prevReading || 0}</td>
                    <td data-client-id="${client.id}" data-field="currentReading" ${currentReadingAttrs}>${invoice.currentReading || ''}</td>
                    <td class="read-only-input">${consumption}</td>
                    <td contenteditable="true" data-client-id="${client.id}" data-field="debt" class="${debtClass}">${debtValue.toFixed(2)}</td>
                    <td contenteditable="true" data-client-id="${client.id}" data-field="customAmount" title="Pode ser editado manualmente">${totalToPay.toFixed(2)}</td>
                `;
                invoicesTableBody.appendChild(row);
            }
        });
    }

    function renderPaymentsTable() {
        paymentsTableBody.innerHTML = '';
        const searchTerm = clientSearchPayments.value.toLowerCase();

        const filteredClients = state.clients.filter(client => {
            const matchesName = client.name.toLowerCase().includes(searchTerm);
            const matchesId = String(client.id).includes(searchTerm);
            return matchesName || matchesId;
        });

        filteredClients.forEach((client, index) => {
            const { totalToPay } = calculateInvoiceTotals(client.id);
            const payment = state.payments[client.id] || { p1: { amount: 0, date: null }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } };
            const totalPaid = (payment.p1.amount || 0) + (payment.p2.amount || 0) + (payment.p3.amount || 0);
            const remaining = totalToPay - totalPaid;

            const row = document.createElement('tr');
            const formatDate = (dateString) => {
                if (!dateString) return '';
                return new Date(dateString).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            };

            row.innerHTML = `
                <td>${client.id}</td>
                <td>${client.name}</td>
                <td class="read-only-input">${totalToPay.toFixed(2)}</td>
                <td class="payment-cell" data-client-id="${client.id}" data-field="p1">
                    <div class="payment-cell-value" title="Clique para editar">${payment.p1.amount || 0}</div>
                    <span class="payment-date">${formatDate(payment.p1.date)}</span>
                </td>
                <td class="payment-cell" data-client-id="${client.id}" data-field="p2">
                    <div class="payment-cell-value" title="Clique para editar">${payment.p2.amount || 0}</div>
                     <span class="payment-date">${formatDate(payment.p2.date)}</span>
                </td>
                <td class="payment-cell" data-client-id="${client.id}" data-field="p3">
                    <div class="payment-cell-value" title="Clique para editar">${payment.p3.amount || 0}</div>
                     <span class="payment-date">${formatDate(payment.p3.date)}</span>
                </td>
                <td class="${remaining > 0 ? 'text-danger' : 'text-success'} read-only-input">${remaining.toFixed(2)}</td>
                <td><button class="btn-primary" data-action="generate-receipt" data-id="${client.id}">Gerar</button></td>
            `;
            paymentsTableBody.appendChild(row);
        });
    }

    function renderContractsTable() {
        contractsTableBody.innerHTML = '';
        Object.keys(state.contracts).forEach(contractId => {
            const contract = state.contracts[contractId];
            const client = state.clients.find(c => c.id == contract.clientId);
            if (!client) return; // Should not happen if data is consistent

            const { totalPaid, remaining } = calculateContractTotals(contractId);

            const row = document.createElement('tr');
            const formatDate = (dateString) => {
                if (!dateString) return '';
                return new Date(dateString).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            };

            row.innerHTML = `
                <td>${contract.id}</td>
                <td>${client.id}</td>
                <td>${client.name}</td>
                <td>${contract.value.toFixed(2)}</td>
                <td class="payment-cell" data-contract-id="${contractId}" data-field="p1">
                    <div class="payment-cell-value" title="Clique para editar">${contract.payments.p1.amount || 0}</div>
                    <span class="payment-date">${formatDate(contract.payments.p1.date)}</span>
                </td>
                <td class="payment-cell" data-contract-id="${contractId}" data-field="p2">
                    <div class="payment-cell-value" title="Clique para editar">${contract.payments.p2.amount || 0}</div>
                    <span class="payment-date">${formatDate(contract.payments.p2.date)}</span>
                </td>
                <td class="payment-cell" data-contract-id="${contractId}" data-field="p3">
                    <div class="payment-cell-value" title="Clique para editar">${contract.payments.p3.amount || 0}</div>
                    <span class="payment-date">${formatDate(contract.payments.p3.date)}</span>
                </td>
                <td class="${remaining > 0 ? 'text-danger' : 'text-success'} read-only-input">${remaining.toFixed(2)}</td>
                <td class="actions-cell">
                    <button class="btn-warning" data-action="generate-contract-receipt" data-id="${contractId}">Recibo</button>
                    <button class="btn-danger" data-action="delete-contract" data-id="${contractId}">Remover</button>
                </td>
            `;
            contractsTableBody.appendChild(row);
        });
    }

    function renderReceipts(startId = null, endId = null) {
        receiptsContainer.innerHTML = '';
        const generatedInvoiceNumbers = new Set();

        const currentDate = new Date();
        const monthName = currentDate.toLocaleString('pt-BR', { month: 'long' }).toUpperCase();
        const year = currentDate.getFullYear();
        
        const customOrder = state.receiptOrder || [];
        const customOrderSet = new Set(customOrder);

        const allActiveClients = state.clients.filter(client => client.situacao === 'A');
        
        const prioritizedClients = [];
        const otherClients = [];

        customOrder.forEach(id => {
            const client = allActiveClients.find(c => c.id === id);
            if (client) {
                prioritizedClients.push(client);
            }
        });
        
        allActiveClients.forEach(client => {
            if (!customOrderSet.has(client.id)) {
                otherClients.push(client);
            }
        });
        
        otherClients.sort((a, b) => a.id - b.id);

        let sortedClients = [...prioritizedClients, ...otherClients];

        let clientsToPrint = sortedClients;
        if (startId !== null && endId !== null) {
            clientsToPrint = sortedClients.filter(client => client.id >= startId && client.id <= endId);
        }
        
        if (clientsToPrint.length === 0 && (startId !== null || endId !== null)) {
            receiptsContainer.innerHTML = '<p>Nenhuma factura de cliente ATIVO encontrada para o intervalo de IDs especificado.</p>';
            return;
        } else if (clientsToPrint.length === 0) {
            receiptsContainer.innerHTML = '<p>Nenhum cliente ativo para gerar facturas.</p>';
            return;
        }

        // --- INÍCIO DA ALTERAÇÃO ---
        clientsToPrint.forEach((client, index) => {
            let invoiceNumber;
            do {
                invoiceNumber = Math.floor(Math.random() * 9000000000) + 1000000000;
            } while (generatedInvoiceNumbers.has(invoiceNumber));
            generatedInvoiceNumbers.add(invoiceNumber);

            const invoice = state.invoices[client.id] || { prevReading: 0, currentReading: 0, debt: 0, customAmount: null };
            const payment = state.payments[client.id] || { p1: { amount: 0 }, p2: { amount: 0 }, p3: { amount: 0 } };
            const { totalToPay } = calculateInvoiceTotals(client.id);
            const totalPaid = (payment.p1.amount || 0) + (payment.p2.amount || 0) + (payment.p3.amount || 0);
            
            const valorEmFalta = totalToPay - totalPaid;
            const debtForReceipt = valorEmFalta;
            const debtClassForReceipt = debtForReceipt > 1124 ? 'text-danger' : '';
            
            const prevReadingForReceipt = invoice.prevReading || 0;
            const counterNumber = String(client.id).padStart(3, '0');

            const receiptHTML = `
            <div class="receipt">
                <div class="receipt-header">
                    <h4>ÁGUA PAZ (TEMBE)</h4>
                    <p>COMPROVATIVO DE PAGAMENTO PELO CONSUMO DE ÁGUA</p>
                </div>
                <div class="receipt-body">
                    <p>
                        <strong>FACTURA Nº</strong><span class="data-field data-field-blue">${invoiceNumber}</span>
                        <strong>MÊS DE</strong><span class="data-field data-field-blue">${monthName}</span>
                        <strong>ANO</strong><span class="data-field data-field-blue">${year}</span>
                        <strong>CONTADOR Nº</strong><span class="data-field data-field-blue">${counterNumber}</span>
                    </p>
                    <p>
                        Para efeitos e fins julgados convenientes, declaramos que a fatura do(a) Sr(a).<span class="data-field data-field-blue">${client.name}</span>
                        residente na casa nº <span class="data-field">___________</span>
                        tem de pagar a quantia de <span class="data-field">__________</span> MZN
                        o valor do consumo mínimo é de 375MZN.
                    </p>
                    <table>
                        <thead>
                            <tr>
                                <th>LEITURA ANTERIOR</th>
                                <th>LEITURA MENSAL</th>
                                <th>LEITURA TOTAL</th>
                                <th>VALOR POR M³</th>
                                <th colspan="2">VALOR A PAGAR</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="data-field">${prevReadingForReceipt}</span></td>
                                <td><span class="data-field"></span></td>
                                <td><span class="data-field"></span></td>
                                <td><span class="data-field">75.00 MZN</span></td>
                                <td>Leitura</td>
                                <td><span class="data-field"></span> MZN</td>
                            </tr>
                            <tr>
                                <td colspan="4"></td>
                                <td>Dívida</td>
                                <td><span class="data-field ${debtClassForReceipt}">${debtForReceipt.toFixed(2)} MZN</span></td>
                            </tr>
                            <tr>
                                <td colspan="4"></td>
                                <td><strong>Total</strong></td>
                                <td><strong><span class="data-field"></span> MZN</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
               
            </div>`;
            receiptsContainer.innerHTML += receiptHTML;

            // Lógica para adicionar a linha divisória
            const position = index + 1; // Posição na lista (1-based)
            const isLastOverall = position === clientsToPrint.length;

            // Adiciona a linha apenas se não for o último recibo do grupo de 3
            // e também não for o último recibo da lista inteira.
            if (!isLastOverall && (position % 3 !== 0)) {
                receiptsContainer.innerHTML += '<hr class="invoice-divider">';
            }
        });
        // --- FIM DA ALTERAÇÃO ---
    }

    function numberToWords(num) {
        const units = ['', 'um', 'dois', 'três', 'quatro', 'cinco', 'seis', 'sete', 'oito', 'nove'];
        const teens = ['dez', 'onze', 'doze', 'treze', 'catorze', 'quinze', 'dezasseis', 'dezassete', 'dezoito', 'dezanove'];
        const tens = ['', '', 'vinte', 'trinta', 'quarenta', 'cinquenta', 'sessenta', 'setenta', 'oitenta', 'noventa'];
        const hundreds = ['', 'cento', 'duzentos', 'trezentos', 'quatrocentos', 'quinhentos', 'seiscentos', 'setecentos', 'oitocentos', 'novecentos'];

        function convertGroup(n) {
            if (n === 0) return '';
            if (n < 10) return units[n];
            if (n >= 10 && n < 20) return teens[n - 10];
            if (n >= 20 && n < 100) {
                return tens[Math.floor(n / 10)] + (n % 10 === 0 ? '' : ' e ' + units[n % 10]);
            }
            if (n >= 100 && n < 1000) {
                if (n === 100) return 'cem';
                return hundreds[Math.floor(n / 100)] + (n % 100 === 0 ? '' : ' e ' + convertGroup(n % 100));
            }
            return '';
        }

        if (num === 0) return 'zero';

        let integerPart = Math.floor(num);
        let decimalPart = Math.round((num - integerPart) * 100);

        let result = '';
        let hundredsGroup = Math.floor(integerPart % 1000);
        let thousandsGroup = Math.floor((integerPart / 1000) % 1000);
        let millionsGroup = Math.floor((integerPart / 1000000) % 1000);
        let billionsGroup = Math.floor(integerPart / 1000000000);

        if (billionsGroup > 0) {
            result += convertGroup(billionsGroup) + ' mil milhões ';
        }
        if (millionsGroup > 0) {
            result += convertGroup(millionsGroup) + (millionsGroup === 1 ? ' milhão ' : ' milhões ');
        }
        if (thousandsGroup > 0) {
            result += (thousandsGroup === 1 && millionsGroup === 0) ? 'mil ' : convertGroup(thousandsGroup) + ' mil ';
        }
        if (hundredsGroup > 0 || (integerPart === 0 && decimalPart === 0)) {
            result += convertGroup(hundredsGroup);
        }
        
        let fullResult = result.trim();
        
        if (integerPart === 1 && !fullResult.includes("milhão") && !fullResult.includes("mil milhões")) {
            fullResult += ' Metical';
        } else if (integerPart > 0) {
            fullResult += ' Meticais';
        }

        if (decimalPart > 0) {
            const decimalWords = convertGroup(decimalPart);
            const separator = fullResult ? ' e ' : '';
            fullResult += separator + decimalWords + (decimalPart === 1 ? ' centavo' : ' centavos');
        }

        return fullResult.charAt(0).toUpperCase() + fullResult.slice(1);
    }

    function generateUniqueBinarySignature() {
        let binaryString;
        do {
            binaryString = '';
            for (let i = 0; i < 25; i++) {
                binaryString += Math.round(Math.random());
            }
        } while (generatedBinarySignatures.has(binaryString));
        generatedBinarySignatures.add(binaryString);
        return binaryString;
    }

    function generateReceipt(clientId) {
        const client = state.clients.find(c => c.id == clientId);
        if (!client) {
            alert("Cliente não encontrado.");
            return;
        }

        const payment = state.payments[clientId] || { p1: { amount: 0, date: null }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } };
        const { totalToPay } = calculateInvoiceTotals(clientId);
        const totalPaid = (payment.p1.amount || 0) + (payment.p2.amount || 0) + (payment.p3.amount || 0);
        const valorEmFalta = totalToPay - totalPaid;

        let lastPaymentAmount = 0;
        let lastPaymentDate = null;
        if (payment.p3.amount > 0 && payment.p3.date) {
            lastPaymentAmount = payment.p3.amount;
            lastPaymentDate = new Date(payment.p3.date);
        } else if (payment.p2.amount > 0 && payment.p2.date) {
            lastPaymentAmount = payment.p2.amount;
            lastPaymentDate = new Date(payment.p2.date);
        } else if (payment.p1.amount > 0 && payment.p1.date) {
            lastPaymentAmount = payment.p1.amount;
            lastPaymentDate = new Date(payment.p1.date);
        }

        const receiptDate = lastPaymentDate || new Date();
        const day = String(receiptDate.getDate()).padStart(2, '0');
        const receiptMonthText = receiptDate.toLocaleString('pt-BR', { month: 'long' }).toUpperCase();
        const fullYear = String(receiptDate.getFullYear());
        
        const invoiceDate = new Date();
        invoiceDate.setDate(1);
        invoiceDate.setMonth(invoiceDate.getMonth() - 1);
        const invoiceMonthName = invoiceDate.toLocaleString('pt-BR', { month: 'long' }).toUpperCase();

        const counterNumber = String(client.id).padStart(3, '0');
        const amountInWords = numberToWords(lastPaymentAmount); 

        const fillWithUnderscores = (text, maxLength) => {
            const currentLength = String(text).length;
            if (currentLength >= maxLength) return String(text);
            return String(text) + '_'.repeat(maxLength - currentLength);
        };
        const getUnderlineClass = (text, maxLength) => {
            return String(text).length >= maxLength ? 'no-underline' : '';
        };

        const machineSignature = generateUniqueBinarySignature();
        const valorEmFaltaClass = valorEmFalta > 1124 ? 'data-field-red' : 'data-field-blue';

        const createSingleReceiptHTML = () => {
            const receiptText = `à fatura de consumo de água do mês de ${invoiceMonthName}`;
            return `
            <div class="recibo-popup">
                <div class="cabecalho">
                  <div class="agua-paz">ÁGUA PAZ (TEMBE)</div>
                  <div class="recibo-num"> <span class="fill-underline ${getUnderlineClass(day, 2)} data-field-blue">${fillWithUnderscores(day, 2)}</span> DE <span class="fill-underline no-underline-month ${getUnderlineClass(receiptMonthText, 10)} data-field-blue">${fillWithUnderscores(receiptMonthText, 10)}</span> DE <span class="fill-underline ${getUnderlineClass(fullYear, 4)} data-field-blue">${fullYear}</span> <br /><br />PAGO <span class="fill-underline ${getUnderlineClass(lastPaymentAmount.toFixed(2), 10)} data-field-blue">${fillWithUnderscores(lastPaymentAmount.toFixed(2), 10)}</span> MT</div>
                </div>

                <div class="linha">Recebemos do Exmo Sr.(a). <span class="fill-underline ${getUnderlineClass(client.name, 40)} data-field-blue">${fillWithUnderscores(client.name, 40)}</span>, portador do contador : <span class="fill-underline ${getUnderlineClass(counterNumber, 5)} data-field-blue">${fillWithUnderscores(counterNumber, 5)}</span></div>
                <div class="linha">a importância de <span class="fill-underline ${getUnderlineClass(amountInWords, 60)} data-field-blue" style="width: 70%;">${fillWithUnderscores(amountInWords, 60)}</span></div>
                <div class="linha"><span class="fill-underline no-underline" style="width: 98%;"></span></div>
                <div class="linha">referente <span class="fill-underline ${getUnderlineClass(receiptText, 70)} data-field-blue">${receiptText}</span> Remanescente <span class="fill-underline ${getUnderlineClass(valorEmFalta.toFixed(2), 10)} ${valorEmFaltaClass}">${fillWithUnderscores(valorEmFalta.toFixed(2), 10)}</span> MT, motivo pelo qual passamos o presente recibo.</div>

                <div class="linha"></div>

                <div class="receipt-top-info">
                  <span class="payment-form-header">Forma de pagamento:</span>
                  <span class="assinatura-header">Assinatura: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                </div>

                <div class="assinatura-checklist-container">
                  <div class="checklist">
                    <label><input type="checkbox"> Cheque nº <span class="fill-underline" style="width: 15ch;"></span></label><br>
                    <label><input type="checkbox"> Banco <span class="fill-underline" style="width: 18ch;"></span></label><br>
                    <label><input type="checkbox"> Outros</label><br>
                    <label><input type="checkbox" checked> Em numerário</label>
                  </div>

                  <div class="assinatura">
                    <span class="fill-underline" style="width: 25ch;"></span>
                    <img src="carimbo.png" alt="Carimbo" class="carimbo-overlay">
                    <br> <br> <strong>ID DO RECIBO&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; </strong> <br /> <br><span class="fill-underline no-underline data-field-yellow">${machineSignature}</span>
                  </div>
                </div>
              </div>
            `;
        };

        const receiptTitle = String(client.id).padStart(3, '0');
        openReceiptInNewWindow(createSingleReceiptHTML(), receiptTitle);
    }

    function generateContractReceipt(contractId) {
        const contract = state.contracts[contractId];
        if (!contract) {
            alert("Contrato não encontrado.");
            return;
        }
        const client = state.clients.find(c => c.id == contract.clientId);
        if (!client) {
            alert("Cliente associado ao contrato não encontrado.");
            return;
        }

        const payment = contract.payments;
        const { remaining } = calculateContractTotals(contractId);
        
        let lastPaymentAmount = 0;
        let lastPaymentDate = null;
        if (payment.p3.amount > 0 && payment.p3.date) {
            lastPaymentAmount = payment.p3.amount;
            lastPaymentDate = new Date(payment.p3.date);
        } else if (payment.p2.amount > 0 && payment.p2.date) {
            lastPaymentAmount = payment.p2.amount;
            lastPaymentDate = new Date(payment.p2.date);
        } else if (payment.p1.amount > 0 && payment.p1.date) {
            lastPaymentAmount = payment.p1.amount;
            lastPaymentDate = new Date(payment.p1.date);
        }

        if (lastPaymentAmount === 0) {
            alert("Não existe nenhum pagamento registado para este contrato.");
            return;
        }

        const receiptDate = lastPaymentDate || new Date();
        const day = String(receiptDate.getDate()).padStart(2, '0');
        const receiptMonthText = receiptDate.toLocaleString('pt-BR', { month: 'long' }).toUpperCase();
        const fullYear = String(receiptDate.getFullYear());
        
        const counterNumber = String(client.id).padStart(3, '0');
        const amountInWords = numberToWords(lastPaymentAmount);

        const fillWithUnderscores = (text, maxLength) => {
            const currentLength = String(text).length;
            if (currentLength >= maxLength) return String(text);
            return String(text) + '_'.repeat(maxLength - currentLength);
        };
        const getUnderlineClass = (text, maxLength) => {
            return String(text).length >= maxLength ? 'no-underline' : '';
        };

        const machineSignature = generateUniqueBinarySignature();
        const valorEmFaltaClass = remaining > 0 ? 'data-field-red' : 'data-field-blue';

        const createSingleReceiptHTML = () => {
            const receiptText = 'à prestação do contrato de água no valor de cinco mil Meticais.';
            return `
            <div class="recibo-popup">
                <div class="cabecalho">
                  <div class="agua-paz">ÁGUA PAZ (TEMBE)</div>
                  <div class="recibo-num"> <span class="fill-underline ${getUnderlineClass(day, 2)} data-field-blue">${fillWithUnderscores(day, 2)}</span> DE <span class="fill-underline no-underline-month ${getUnderlineClass(receiptMonthText, 10)} data-field-blue">${fillWithUnderscores(receiptMonthText, 10)}</span> DE <span class="fill-underline ${getUnderlineClass(fullYear, 4)} data-field-blue">${fullYear}</span> <br /><br />PAGO <span class="fill-underline ${getUnderlineClass(lastPaymentAmount.toFixed(2), 10)} data-field-blue">${fillWithUnderscores(lastPaymentAmount.toFixed(2), 10)}</span> MT</div>
                </div>

                <div class="linha">Recebemos do Exmo Sr.(a). <span class="fill-underline ${getUnderlineClass(client.name, 40)} data-field-blue">${fillWithUnderscores(client.name, 40)}</span>, portador do contador : <span class="fill-underline ${getUnderlineClass(counterNumber, 5)} data-field-blue">${fillWithUnderscores(counterNumber, 5)}</span></div>
                <div class="linha">a importância de <span class="fill-underline ${getUnderlineClass(amountInWords, 60)} data-field-blue" style="width: 70%;">${fillWithUnderscores(amountInWords, 60)}</span></div>
                <div class="linha"><span class="fill-underline no-underline" style="width: 98%;"></span></div>
                <div class="linha">referente <span class="fill-underline ${getUnderlineClass(receiptText, 70)} data-field-blue">${receiptText}</span> Remanescente <span class="fill-underline ${getUnderlineClass(remaining.toFixed(2), 10)} ${valorEmFaltaClass}">${fillWithUnderscores(remaining.toFixed(2), 10)}</span> MT, motivo pelo qual passamos o presente recibo.</div>

                <div class="linha"></div>

                <div class="receipt-top-info">
                  <span class="payment-form-header">Forma de pagamento:</span>
                  <span class="assinatura-header">Assinatura: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                </div>

                <div class="assinatura-checklist-container">
                  <div class="checklist">
                    <label><input type="checkbox"> Cheque nº <span class="fill-underline" style="width: 15ch;"></span></label><br>
                    <label><input type="checkbox"> Banco <span class="fill-underline" style="width: 18ch;"></span></label><br>
                    <label><input type="checkbox"> Outros</label><br>
                    <label><input type="checkbox" checked> Em numerário</label>
                  </div>

                  <div class="assinatura">
                    <span class="fill-underline" style="width: 25ch;"></span>
                    <img src="carimbo.png" alt="Carimbo" class="carimbo-overlay">
                    <br> <br> <strong>ID DO RECIBO&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; </strong> <br /> <br><span class="fill-underline no-underline data-field-yellow">${machineSignature}</span>
                  </div>
                </div>
              </div>
            `;
        };
        
        const receiptTitle = String(client.id).padStart(3, '0');
        openReceiptInNewWindow(createSingleReceiptHTML(), receiptTitle);
    }

    function openReceiptInNewWindow(htmlContent, title) {
        const safeTitle = title || 'Recibo de Pagamento';
        const newWindow = window.open('', '_blank', 'width=800,height=600');
        newWindow.document.open();
        newWindow.document.write(`
        <!DOCTYPE html>
        <html lang="pt">
        <head>
          <meta charset="UTF-8">
          <title>${safeTitle}</title>
          <style>
            @media print {
              body {
                margin: 0;
                padding: 0;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                height: 29.7cm; /* A4 height */
                width: 21cm; /* A4 width */
                overflow: hidden; /* Hide scrollbars */
              }
              .recibo-popup {
                  width: 21cm !important;
                  height: 11.8cm !important;
                  margin: 0.8cm 0 0.4cm !important;
                  border: 1px solid black !important;
                  box-sizing: border-box !important;
                  font-family: monospace !important;
                  position: relative !important;
                  page-break-after: auto !important;
                  page-break-inside: avoid;
              }
              
              .recibo-popup .cabecalho .agua-paz {
                  font-size: 15pt;
              }
              .recibo-popup .cabecalho .recibo-num {
                  font-size: 11pt;
              }
              .recibo-popup .linha {
                  font-size: 9pt;
                  line-height: 1.2;
              }
              .recibo-popup .checklist label {
                  font-size: 8pt;
              }
              .recibo-popup .assinatura-maquina {
                  font-size: 10pt;
              }
               .carimbo-overlay {
                    top: 21.7px !important;
                    margin-left: 187.3px !important;
                    width: 383px !important;
                }
            .receipt-divider-print {
                border: none;
                border-top: 1px dashed #999;
                margin: 0.4cm auto !important;
                width: 80% !important;
                display: block !important;
            }
            .receipt-body table {
                font-size: 8pt !important;
                margin-top: 0.3cm !important;
            }
            .receipt-body table th,
            .receipt-body table td {
                padding: 0.15cm !important;
                border: 1px solid #333 !important;
            }
            .receipt-footer {
                font-size: 8pt !important;
                margin-top: 0.3cm !important;
                padding-top: 0.15cm !important;
            }
            .receipt-footer p {
                margin-bottom: 0 !important;
            }
            .recibo-popup .assinatura-checklist-container {
                flex-direction: row !important;
                justify-content: space-between !important;
                align-items: flex-start !important;
            }
            .recibo-popup .checklist,
            .recibo-popup .assinatura {
                width: 48% !important;
                margin-bottom: 0 !important;
            }
            .recibo-popup .assinatura {
                text-align: right !important;
            }

            .recibo-popup .receipt-top-info {
                display: flex !important;
                justify-content: space-between !important;
                align-items: flex-end !important;
                font-weight: bold !important;
                font-size: 9pt !important;
                margin-bottom: 5px !important;
            }

            .recibo-popup .receipt-top-info .assinatura-header-print {
                margin-top: 0 !important;
                margin-bottom: 0 !important;
            }
        }

            .recibo-popup {
              width: 97%;
              height: 45%; 
              border: 1px solid black;
              padding: 20px;
              box-sizing: border-box;
              font-family: monospace;
              position: relative;
            }

            .recibo-popup .cabecalho {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            }

            .recibo-popup .agua-paz {
              font-size: 20px;
              font-weight: bold;
              text-transform: uppercase;
            }

            .recibo-popup .recibo-num {
              font-size: 16px;
              text-align: right;
            }

            .recibo-popup .linha {
              margin: 10px 0;
            }

            .recibo-popup .assinatura {
              margin-top: 10px;
              text-align: right;
              position: relative;
            }
            .recibo-popup .assinatura .assinatura-header {
                font-weight: bold;
                font-size: 1rem;
            }


            .recibo-popup .assinatura-maquina {
              margin-top: 30px;
              font-size: 14px;
            }

            .recibo-popup .checklist {
              margin-top: 10px;
              text-align: left;
            }
            .recibo-popup .checklist .payment-form-header {
                font-weight: bold;
                font-size: 1rem;
            }


            .recibo-popup .assinatura-checklist-container {
              display: flex;
              flex-direction: column;
              justify-content: space-between;
              align-items: flex-start;
              margin-top: 30px;
            }

            .recibo-popup .checklist,
            .recibo-popup .assinatura {
              width: 100%;
              margin-bottom: 20px;
            }
            .recibo-popup .assinatura {
                text-align: left;
            }

            .recibo-popup .receipt-top-info {
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
                margin-bottom: 10px;
                font-weight: bold;
            }
            .recibo-popup .receipt-top-info .assinatura-header {
                margin-top: 10px;
                margin-bottom: 0;
            }


            .fill-underline {
                font-family: monospace;
                white-space: pre;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                min-width: 50px;
                border-bottom: 1px solid black;
                box-sizing: border-box;
                padding: 0 2px;
            }
            .fill-underline.no-underline {
                border-bottom: none;
                text-decoration: none;
            }
            .data-field-blue { color: blue; }
            .data-field-red { color: red; }
            .data-field-yellow {
                color: orange;
                font-weight: bold;
                font-size: 1.05em;
            }
            .no-underline-month {
                text-decoration: none !important;
                border-bottom: none !important;
            }
            .carimbo-overlay {
                position: absolute;
                top: 13.9px;
                left: 50%;
                transform: translateX(-50%);
                width: 434px;
                height: auto;
                opacity: 0.8;
                z-index: 10;
                margin-left: 196.56px;
            }
            @media (max-width: 768px) {
                .carimbo-overlay {
                    top: auto !important;
                    bottom: -76.7px;
                    left: 142.3px !important;
                    transform: translateX(0) !important;
                    width: 255px !important;
                    margin-left: 0 !important;
                }
            }
          </style>
        </head>
        <body>
          ${htmlContent}
          <hr class="receipt-divider-print">
          ${htmlContent}
        </body>
        </html>
        `);
        newWindow.document.close();
        newWindow.focus();
        newWindow.print();
    }


    // --- LÓGICA DE EVENTOS ---
    menuButton.addEventListener('click', () => sideMenu.classList.toggle('open'));

    authForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (verificationCodeInput.value === FIXED_VERIFICATION_CODE) {
            authSection.classList.add('hidden');
            adminActions.classList.remove('hidden');
        } else {
            alert('Código de verificação incorreto!');
        }
        verificationCodeInput.value = '';
    });

    adminActions.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        const action = e.target.dataset.action;
        const view = e.target.dataset.view;

        if (action === 'add-client') {
            clientModalTitle.textContent = 'Adicionar Cliente';
            clientForm.reset();
            clientIdInput.value = '';
            clientModal.classList.remove('hidden');
        } else if (action === 'add-contract') {
            openContractModal();
        } 
        // NOVO: Ações de exportar e importar
        else if (action === 'export-data') {
            exportDataToFile();
        } else if (action === 'import-data') {
            importFileInput.click(); // Abre o seletor de ficheiros
        }
        
        if (view) {
            views.forEach(v => v.classList.add('hidden'));
            document.getElementById(view).classList.remove('hidden');
            sideMenu.classList.remove('open');
            if (view === 'clients-view') renderClientsTable();
            if (view === 'invoices-view') renderInvoicesTable();
            if (view === 'payments-view') renderPaymentsTable();
            if (view === 'contracts-view') renderContractsTable();
            if (view === 'receipts-view') renderReceipts();
        }
    });

    closeClientModalButton.addEventListener('click', () => clientModal.classList.add('hidden'));
    clientModal.addEventListener('click', (e) => {
        if (e.target === clientModal) clientModal.classList.add('hidden');
    });

    clientForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = clientIdInput.value;
        const clientData = {
            name: clientNameInput.value,
            contact: clientContactInput.value,
            connectionDate: clientConnectionDateInput.value,
        };
        requestVerificationCode(() => {
            if (id) {
                const index = state.clients.findIndex(c => c.id == id);
                if (index > -1) {
                    state.clients[index] = { ...state.clients[index], ...clientData };
                }
            } else {
                const newId = state.clients.length > 0 ? Math.max(...state.clients.map(c => c.id)) + 1 : 1;
                state.clients.push({ id: newId, ...clientData, situacao: 'A' });
                state.invoices[newId] = { prevReading: 0, currentReading: 0, debt: 0, customAmount: null };
                state.payments[newId] = { p1: { amount: 0, date: null }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } };
            }
            saveData();
            renderAllTables();
            clientModal.classList.add('hidden');
        });
    });

    clientsTableBody.addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList.contains('action-toggle')) {
            target.nextElementSibling.classList.toggle('visible');
            return;
        }
        const action = target.dataset.action;
        const id = target.dataset.id;
        if (!action || !id) return;

        if (action === 'edit') {
            const client = state.clients.find(c => c.id == id);
            if (client) {
                clientModalTitle.textContent = 'Editar Cliente';
                clientIdInput.value = client.id;
                clientNameInput.value = client.name;
                clientContactInput.value = client.contact;
                clientConnectionDateInput.value = client.connectionDate;
                clientModal.classList.remove('hidden');
            }
        } else if (action === 'delete') {
            if (confirm(`Tem a certeza que deseja remover o cliente #${id}? Esta ação não pode ser desfeita.`)) {
                requestVerificationCode(() => {
                    state.clients = state.clients.filter(c => c.id != id);
                    delete state.invoices[id];
                    delete state.payments[id];
                    for (const contractId in state.contracts) {
                        if (state.contracts[contractId].clientId == id) {
                            delete state.contracts[contractId];
                        }
                    }
                    saveData();
                    renderAllTables();
                });
            }
        } else if (action === 'reset-meter') {
            if (confirm(`Tem a certeza que deseja simular a troca do contador para o cliente #${id}? A dívida atual será calculada e transferida, e as leituras serão zeradas.`)) {
                requestVerificationCode(() => {
                    const invoice = state.invoices[id] || { prevReading: 0, currentReading: 0, debt: 0, customAmount: null };
                    const payment = state.payments[id] || { p1: { amount: 0, date: null }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } };
                    
                    const { totalToPay } = calculateInvoiceTotals(id);
                    const totalPaid = (payment.p1.amount || 0) + (payment.p2.amount || 0) + (payment.p3.amount || 0);
                    const remainingAmount = totalToPay - totalPaid;

                    state.invoices[id].debt = remainingAmount > 0 ? remainingAmount : 0;
                    state.invoices[id].prevReading = 0;
                    state.invoices[id].currentReading = 0;
                    state.invoices[id].customAmount = null;

                    state.payments[id] = { p1: { amount: 0, date: null }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } };

                    saveData();
                    renderAllTables();
                    alert(`Contador para o cliente #${id} foi trocado com sucesso. Leituras zeradas e dívida atualizada.`);
                });
            }
        }
    });

    paymentsTableBody.addEventListener('click', (e) => {
        const target = e.target;
        if (target.dataset.action === 'generate-receipt') {
            const clientId = target.dataset.id;
            generateReceipt(clientId);
        }
    });

    function handleSituacaoChange(e) {
        const select = e.target;
        if (!select.classList.contains('situacao-select')) return;
        const clientId = select.dataset.clientId;
        const newSituacao = select.value;
        const client = state.clients.find(c => c.id == clientId);
        if (!client) return;
        const originalSituacao = client.situacao || 'A';
        const invoice = state.invoices[clientId] || { prevReading: 0, currentReading: 0, debt: 0, customAmount: null };
        const payment = state.payments[clientId] || { p1: { amount: 0 }, p2: { amount: 0 }, p3: { amount: 0 } };

        requestVerificationCode(() => {
            client.situacao = newSituacao;
            if (newSituacao === 'N') {
                const { totalToPay } = calculateInvoiceTotals(clientId);
                const totalPaid = (payment.p1.amount || 0) + (payment.p2.amount || 0) + (payment.p3.amount || 0);
                const valorEmFalta = totalToPay - totalPaid;
                
                invoice.customAmount = valorEmFalta + 375;
                invoice.debt = 0;
            } else if (originalSituacao === 'N' && newSituacao !== 'N') {
                invoice.customAmount = null;
            } else if (newSituacao === 'F') {
                const { totalToPay } = calculateInvoiceTotals(clientId);
                const totalPaid = (payment.p1.amount || 0) + (payment.p2.amount || 0) + (payment.p3.amount || 0);
                const valorEmFalta = totalToPay - totalPaid;
                
                invoice.customAmount = valorEmFalta;
            } else if (originalSituacao === 'F' && newSituacao !== 'F') {
                invoice.customAmount = null;
            }
            saveData();
            renderAllTables();
        }, () => {
            select.value = originalSituacao;
        });
    }

    function handleCellEdit(e) {
        const cell = e.target.closest('td[contenteditable="true"]');
        if (!cell) return;

        if (e.type === 'focus') {
            originalCellValue = cell.textContent.trim();
        } else if (e.type === 'blur') {
            const newCellValue = cell.textContent.trim();
            if (newCellValue !== originalCellValue) {
                 requestVerificationCode(() => {
                    updateStateFromCell(cell, newCellValue);
                 }, () => {
                    cell.textContent = originalCellValue;
                 });
            }
        } else if (e.type === 'keydown' && e.key === 'Enter') {
            e.preventDefault();
            cell.blur();
        }
    }
    
    function updateStateFromCell(cell, value) {
        const clientId = cell.dataset.clientId;
        const field = cell.dataset.field;
        const client = state.clients.find(c => c.id == clientId);
        if (!client || !field) {
            renderAllTables();
            return;
        }

        const parsedValue = parseFloat(value.replace(',', '.'));
        if (isNaN(parsedValue)) {
            alert("Por favor, insira um valor numérico válido.");
            renderAllTables();
            return;
        }
        
        if ((client.situacao === 'F' || client.situacao === 'N') && (field === 'prevReading' || field === 'currentReading')) {
            alert(`Não é possível alterar as leituras de um cliente com a situação "${client.situacao}".`);
            renderAllTables();
            return;
        }

        if (field === 'currentReading') {
            const currentInvoice = state.invoices[clientId];
            const prevReading = currentInvoice ? (currentInvoice.prevReading || 0) : 0;
            if (parsedValue < prevReading) {
                alert("A leitura atual não pode ser menor que a leitura anterior.");
                renderInvoicesTable();
                return; 
            }
        }

        if (['prevReading', 'currentReading', 'debt', 'customAmount'].includes(field)) {
             if (field === 'customAmount') {
                 const { totalToPay } = calculateInvoiceTotals(clientId);
                 state.invoices[clientId].customAmount = (Math.abs(parsedValue - totalToPay) > 0.01) ? parsedValue : null;
             } else {
                state.invoices[clientId][field] = parsedValue;
                 if(field === 'currentReading' || field === 'debt') {
                    state.invoices[clientId].customAmount = null;
                 }
             }
             renderInvoicesTable();
             renderPaymentsTable();
        }
        saveData();
    }

    function handlePaymentClick(e) {
        const cell = e.target.closest('.payment-cell');
        if (!cell) return;
        const clientId = cell.dataset.clientId;
        const field = cell.dataset.field;
        const payment = state.payments[clientId] || { p1: { amount: 0, date: null }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } };
        const currentAmount = payment[field].amount || 0;

        requestVerificationCode(() => {
            const newAmountStr = prompt(`Insira o novo valor para o ${field.replace('p', '')}º pagamento:`, currentAmount);
            if (newAmountStr === null) return;
            const newAmount = parseFloat(newAmountStr.replace(',', '.'));
            if (isNaN(newAmount)) {
                alert("Valor inválido. Por favor, insira um número.");
                return;
            }

            const { totalToPay } = calculateInvoiceTotals(clientId);
            const paymentsExceptCurrent = Object.keys(payment)
                .filter(key => key !== field)
                .reduce((sum, key) => sum + (payment[key].amount || 0), 0);

            if (paymentsExceptCurrent + newAmount > totalToPay) {
                alert("O total dos pagamentos não pode exceder o valor total a pagar.");
                return;
            }

            payment[field].amount = newAmount;
            payment[field].date = (newAmount > 0) ? new Date().toISOString() : null;
            saveData();
            renderPaymentsTable();
            renderInvoicesTable();
        });
    }

    function handleContractPaymentClick(e) {
        const cell = e.target.closest('.payment-cell');
        if (!cell) return;
        const contractId = cell.dataset.contractId;
        const field = cell.dataset.field;
        const contract = state.contracts[contractId];
        if (!contract) return;

        const currentAmount = contract.payments[field].amount || 0;

        requestVerificationCode(() => {
            const newAmountStr = prompt(`Insira o novo valor para o ${field.replace('p', '')}º pagamento do contrato:`, currentAmount);
            if (newAmountStr === null) return;
            const newAmount = parseFloat(newAmountStr.replace(',', '.'));
            if (isNaN(newAmount)) {
                alert("Valor inválido. Por favor, insira um número.");
                return;
            }

            const paymentsExceptCurrent = Object.keys(contract.payments)
                .filter(key => key !== field)
                .reduce((sum, key) => sum + (contract.payments[key].amount || 0), 0);
            
            if (paymentsExceptCurrent + newAmount > contract.value) {
                alert(`O valor total dos pagamentos (${(paymentsExceptCurrent + newAmount).toFixed(2)} MZN) não pode exceder o valor do contrato (${contract.value.toFixed(2)} MZN).`);
                return;
            }

            contract.payments[field].amount = newAmount;
            contract.payments[field].date = (newAmount > 0) ? new Date().toISOString() : null;
            saveData();
            renderContractsTable();
        });
    }

    newMonthButton.addEventListener('click', () => {
        const clientsWithoutCurrentReading = state.clients.filter(client =>
            client.situacao === 'A' && (!state.invoices[client.id] || !state.invoices[client.id].currentReading)
        );

        if (clientsWithoutCurrentReading.length > 0) {
            const clientNames = clientsWithoutCurrentReading.map(c => c.name).join(', ');
            alert(`Não é possível iniciar um novo mês. Os seguintes clientes com situação 'A' não têm leitura atual: ${clientNames}.`);
            return;
        }


        if (confirm("Tem a certeza que deseja iniciar um novo mês? Esta ação irá arquivar os valores atuais e não pode ser desfeita.")) {
            requestVerificationCode(() => {
                state.clients.forEach(client => {
                    const clientId = client.id;
                    const invoice = state.invoices[clientId] || { prevReading: 0, currentReading: 0, debt: 0, customAmount: null };
                    const payment = state.payments[clientId] || { p1: { amount: 0 }, p2: { amount: 0 }, p3: { amount: 0 } };
                    const totalPaid = (payment.p1.amount || 0) + (payment.p2.amount || 0) + (payment.p3.amount || 0);
                    
                    let remainingAmount;
                    const { totalToPay } = calculateInvoiceTotals(clientId);
                    remainingAmount = totalToPay - totalPaid;
                    
                    state.invoices[clientId].debt = remainingAmount > 0 ? remainingAmount : 0;
                    state.invoices[clientId].prevReading = invoice.currentReading || 0;
                    state.invoices[clientId].currentReading = 0;
                    state.invoices[clientId].customAmount = null;

                    state.payments[clientId] = { p1: { amount: 0, date: null }, p2: { amount: 0, date: null }, p3: { amount: 0, date: null } };
                });
                saveData();
                renderAllTables();
                alert('Novo mês iniciado com sucesso! Os valores foram atualizados.');
            });
        }
    });

    // --- Contratos Logic ---
    function openContractModal(contract = null) {
        contractForm.reset();
        contractIdInput.value = '';
        contractModalTitle.textContent = 'Adicionar Contrato';
        contractValueInput.value = 5000;

        contractClientSelect.innerHTML = '<option value="">Selecione um cliente</option>';
        state.clients.forEach(client => {
            const hasContract = Object.values(state.contracts).some(c => c.clientId === client.id);
            const option = document.createElement('option');
            option.value = client.id;
            option.textContent = `${client.name} (ID: ${client.id})`;
            if (hasContract) {
                option.disabled = true;
                option.textContent += ' (Já tem contrato)';
            }
            contractClientSelect.appendChild(option);
        });

        contractModal.classList.remove('hidden');
    }

    closeContractModalButton.addEventListener('click', () => contractModal.classList.add('hidden'));
    contractModal.addEventListener('click', (e) => {
        if (e.target === contractModal) contractModal.classList.add('hidden');
    });

    contractForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const clientId = parseInt(contractClientSelect.value);
        const contractValue = parseFloat(contractValueInput.value);

        if (isNaN(clientId) || !clientId) {
            alert("Por favor, selecione um cliente.");
            return;
        }
        if (isNaN(contractValue) || contractValue <= 0) {
            alert("Por favor, insira um valor de contrato válido.");
            return;
        }

        const existingContract = Object.values(state.contracts).find(c => c.clientId === clientId);
        if (existingContract) {
            alert("Este cliente já possui um contrato.");
            return;
        }

        requestVerificationCode(() => {
            const existingContractIds = Object.keys(state.contracts).map(Number);
            const maxId = existingContractIds.length > 0 ? Math.max(...existingContractIds) : 1000;
            const newContractId = maxId + 1;

            state.contracts[newContractId] = {
                id: newContractId,
                clientId: clientId,
                value: contractValue,
                payments: {
                    p1: { amount: 0, date: null },
                    p2: { amount: 0, date: null },
                    p3: { amount: 0, date: null }
                }
            };
            saveData();
            renderContractsTable();
            contractModal.classList.add('hidden');
        });
    });


    contractsTableBody.addEventListener('click', (e) => {
        const target = e.target;
        const action = target.dataset.action;
        const contractId = target.dataset.id;
        
        if (action === 'delete-contract') {
            if (confirm(`Tem a certeza que deseja remover o contrato #${contractId}? Esta ação não pode ser desfeita.`)) {
                requestVerificationCode(() => {
                    delete state.contracts[contractId];
                    saveData();
                    renderContractsTable();
                });
            }
        } else if (action === 'generate-contract-receipt') {
            generateContractReceipt(contractId);
        }
    });


    // --- Event Listeners ---
    clientsTableBody.addEventListener('change', handleSituacaoChange);
    invoicesTableBody.addEventListener('focus', handleCellEdit, true);
    invoicesTableBody.addEventListener('blur', handleCellEdit, true);
    invoicesTableBody.addEventListener('keydown', handleCellEdit);
    paymentsTableBody.addEventListener('click', handlePaymentClick);
    contractsTableBody.addEventListener('click', handleContractPaymentClick);
    clientSearchClients.addEventListener('input', renderClientsTable);
    clientSearchPayments.addEventListener('input', renderPaymentsTable);
    invoiceSearch.addEventListener('input', renderInvoicesTable);

    // NOVO: Listener para o input de ficheiro de importação
    importFileInput.addEventListener('change', importDataFromFile);

    generateReceiptsByRangeButton.addEventListener('click', () => {
        const startId = parseInt(clientStartIdInput.value);
        const endId = parseInt(clientEndIdInput.value);

        if (isNaN(startId) || isNaN(endId)) {
            alert('Por favor, insira um ID de cliente inicial e final válidos.');
            return;
        }
        if (startId <= 0 || endId <= 0) {
            alert('Os IDs dos clientes devem ser maiores que zero.');
            return;
        }
        if (startId > endId) {
            alert('O ID inicial não pode ser maior que o ID final.');
            return;
        }

        renderReceipts(startId, endId);
    });
    
    editReceiptOrderButton.addEventListener('click', () => {
        const currentOrderStr = state.receiptOrder.join(', ');
        const newOrderStr = prompt("Edite a sequência de IDs dos clientes, separados por vírgula:", currentOrderStr);

        if (newOrderStr === null) {
            return;
        }

        const newOrderArray = newOrderStr
            .split(',')
            .map(s => s.trim())
            .filter(s => s !== '')
            .map(s => parseInt(s, 10))
            .filter(num => !isNaN(num));

        requestVerificationCode(() => {
            state.receiptOrder = newOrderArray;
            saveData();
            renderReceipts(); 
            alert('Ordem da lista atualizada com sucesso!');
        });
    });

    // --- INICIALIZAÇÃO ---
    loadData();
    renderAllTables();
    document.getElementById('clients-view').classList.remove('hidden');
});
</script>
</body>
</html>
